---
title: manuscraps
format:
  pdf:
    keep-tex: false  
    toc: false
number-sections: false
bibliography: solanum-aa.bib
csl: https://www.zotero.org/styles/science
---

### MANUSCRAPS

(not sure where this goes)  * We acclimated the focal leaf to high light (\ppfdequals{2000}) and high relative humidity (\rhequals{70}) until $A$ and \gsw{} reach their maximum. After that, we decreased \rh{} to $\approx 10\%$ to induce rapid stomatal closure without biochemical down

Problems to bring up in discussion:
- all our species were amphi, so they may all live in PAI below threshold to favor amphi
- other microclimate diffs not considered
- don't know specific anatomical change

Two outstanding areas for further research are 1) the specific anatomical changes, such as leaf thickness or mesophyll porosity, that increase the diffusion path length for CO$_2$ in sun leaves, and 2) the costs of amphistomy that could explain plasticity in \gmaxratio{} in populations from low-light habitats. Resolving the first question will require detailed anatomical measurements on a large number of shade and sun leaves with concomitant estimates of \aax. The fact that populations from low-light habitats are more plastic suggests that costs of amphistomy are greatest in these environments. (not finished yet)

Not sure where this goes: We infer this from the fact that blocking gas exchange in pseudohypostomatous leaves reduced $A$ by X-X% depending on the population, light treatment, and light intensity (Table/figure). The AA is equivalent to an X-X% change in total $g_\text{sc}$ (see SI section gs equivalency). But whereas increasing $g_\text{sc}$ would increase water loss as a necessary by-product, amphistomy can increase $A$ without any appreciable affect on transpiration.



from Mott and Oleary: "However, Jones and Slatyer (5) reported a higher mesophyll resistance for CO, entering through the upper stomata than for the lower, and the data of Vaclavik (12) appear to support this conclusion"

8. What it all means
  * Our study reveals an important role for plasticity in explaining why amphi leaves are more common in sunny habitats
  * Confirms that leaf structure of sun leaves incurs costs that amphistomy can mitigate
  * It will be useful to consider coordination between leaf anatomy, stomatal density, and ratio in future studies of leaf structure-function and in crops (or something)


I am using this approach to drafting the paper:

https://blogs.nature.com/nyc/2011/08/10/how-to-write-a-paper-one-possible-answer

## Punchline

Plastic changes in the structure of sun leaves can increase the intercellular CO$_2$ diffusion path length. Gas exchange through stomata on both upper and lower leaf surfaces, amphistomy, may be a compensatory mechanism to reduce the impact of increased diffusion path length on photosynthesis without increasing water loss. We demonstrate for the first time that sun leaves benefit most from amphistomy because it compensates for plastic structural changes in leaf anatomy.

What's surprising: role of developmental plasticity in explaining comparative results; diffusional limitations through palisade ias is strong and needs to be considered with light gradients in understanding leaf strucuture- funciton



big implications - if trees were amphi, more more carbon sink or reduced transpiration

It is commonly assumed in comparative studies that most trait variation between species is constitutive and genetically determined, but our results suggest that plastic responses to light are necessary to explain why \gmaxratio{} increases with light habitat. Reaction norms to light intensity among wild tomatoes indicate that populations from low light habitats express low \gmaxratio{} when grown in shade, whereas populations from high light habitats have constitutively higher \gmaxratio{} (Fig. rxn-norm). The larger response to light intensity is driven by greater plasticty in leaf structure in populations from low-light habitats (Fig/table - I haven't tested this yet, so this is a placeholder.) We infer that these structural changes in sun leaves are costly because they increase the diffusion path length for CO$_2$ and reduce photosynthesis. As a consequence, sun leaves benefit more from amphistomy. This is the first demonstration that sun leaves benefit more from amphistomy because it compensates for developmental plasticity in leaf structure.


### Cleaning \aqcurve{} curves

The raw data set consisted of `r prettyNum(aa_stats$n_aq_curve0, big.mark = ",")` \aqcurve{} curves with an average of `r formatC(aa_stats$n_point_per_aq_curve0, digits = 3)`. Manual curation of a data set this size in a principled, consistent manner is not feasible. Therefore, we automated data cleaning using custom *R* scripts. Cleaning is divided into two sequential steps (\autoref{tbl-cleaning2}).

```{r, cleaning2,echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-cleaning2
#| tbl-cap: "Two sequential steps for cleaning \\agcurve{} curves. The rationale and procedure for each step are described in the text. The rightmost columns summarize the number of curves and mean number of points per curve remaining after each step."

step_description_col = c(
  "1. remove outliers within each \\aqcurve{} curve",
  "2. remove \\aqcurve{} curves with poor fit"
)

n_curve_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_aq_curve[1-9]$")]) |>
  prettyNum(big.mark = ",")

n_point_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_point_per_aq_curve[1-9]$")])

tibble(
  `Step: description` = step_description_col,
  `Number of curves` = n_curve_col,
  `Number of points per curve` = n_point_col
) |>
  knitr::kable(format = "latex",
               align = c("l", "c", "c"),
               digits = c(0, 0, 1),
               booktabs = TRUE, escape = FALSE) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "9cm") |>
  kableExtra::column_spec(2, width = "2.5cm") |>
  kableExtra::column_spec(3, width = "2.5cm")

```

#### Remove outliers within each \aqcurve{} curve

*Rationale*: Individual outliers within \agcurve{} curves, usually caused by transitory changes in chamber conditions, exert undue leverage on parameter estimates and cause bias and/or low precision in parameter estimates.

*Procedure*: We fit provisional nonrectangular hyperbola [@marshall_model_1980] to each \aqcurve{} curve using nonlinear regression with the `nlsLM()` function from the *R* package **minpack.lm** version `r packageVersion("minpack.lm")` [@elzhov_minpacklm_2023]. We sequentially removed data points with an absolute external studentized residual $> `r point_outlier_threshold`$ until none remained.

#### Remove \aqcurve{} curves with poor fit

*Rationale*: \aqcurve{} curves with a poor fit to the nonrectangular hyperbola most likely indicate systematic measurement error and/or the leaf was not fully acclimated to the chamber environment. 

*Procedure*: As described above, we fit provisional nonrectangular hyperbola to each \aqcurve{} curve and calculated the model $r^2$. There was a clear break between typical curves and poorly fitting curves where $r^2 < `r aq_r2_threshold`$. We therefore removed \aqcurve{} curves with $r^2 < `r aq_r2_threshold`$.

## table describing 5 original competing models

```{r, models, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-models
#| tbl-cap: "Summary of differences among competing models of how \\aax{} varies with light intensity, light treatment, and among populations as a function of native \\ppfd. The models are numbered from simpler to more complex. All models include fixed effects of light intensity and light treatment; some models include interactions between. All models include a phylogenetic random effect of population on \\aax; some models include varying effects of light intensity and light treatment among populations. The last column indicates the population-level \\aax{} variable we used as a response to native \\ppfd."

tribble(
    ~"Model", ~"Fixed effects", ~"Phylogenetic random effects", ~"Response to native \\ppfd",
    "1", "light intensity", "varying intercept among populations", "$\\mathrm{AA}_{0, \\text{acc}}$",
    "1", "light treatment", "", "",
    "2", "light intensity", "varying intercept among populations", "$\\mathrm{AA}_{0, \\text{acc}}$",
    "2", "light treatment", "", "",
    "2", "intensity $\\times$ treatment", "", "",
    "3", "light intensity", "varying intercept among populations", "$\\mathrm{AA}_{2000, \\text{acc}}$",
    "3", "light treatment", "varying effect of high light intensity among populations", "",
    "4", "light intensity", "varying intercept among populations", "$\\mathrm{AA}_{\\text{sun, acc}}$",
    "4", "light treatment", "varying effect of sun treatment among populations", "",
    "5", "light intensity", "varying intercept among populations", "$\\mathrm{AA}_{2000, \\text{sun, acc}}$",
    "5", "light treatment", "varying effect of high light intensity among populations", "",
    "5", "intensity $\\times$ treatment", "varying effect of sun treatment among populations", ""
  ) |>
  knitr::kable(
    format = "latex",
    align = c("c", "l", "l", "l"),
    booktabs = TRUE,
    escape = FALSE,
    longtable = FALSE
  ) |>
    kableExtra::collapse_rows(columns = 1, latex_hline = "major", row_group_label_position = "first") |>
  kableExtra::column_spec(1, width = "0.3in") |>
  kableExtra::column_spec(2, width = "1.3in") |>
  kableExtra::column_spec(3, width = "3.4in") |>
  kableExtra::column_spec(4, width = "1in")

```

## table of all parameters

```{r, parameters, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-parameters
#| tbl-cap: "Description of parameters estimated in the hierarchical Bayesian model. The `Parameter` column lists the parameter name as it appears in text. The `Description` column provides a brief description of the parameter."

df_parameters = read_csv("../data/parameters1.csv", col_types = "ccccl") |>
    dplyr::filter(include)

df_parameters |>
  dplyr::select(Parameter = latex, Description = description) |>
  knitr::kable(
    format = "latex",
    align = c("l", "l"),
    booktabs = TRUE,
    escape = FALSE,
    longtable = TRUE
  ) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "1in") |>
  kableExtra::column_spec(2, width = "5in") |>
  kableExtra::pack_rows("\\agcurve{} curve parameters",
                        min(which(df_parameters$par_type == "ags")),
                        max(which(df_parameters$par_type == "ags")),
                        escape = FALSE) |>
  kableExtra::pack_rows("\\aax{} for each light intensity with leaf using \\agcurve{} curve parameters",
                        min(which(df_parameters$par_type == "aa_est")),
                        max(which(df_parameters$par_type == "aa_est")),
                        escape = FALSE) |>
  kableExtra::pack_rows("effects of light intensity, light treatments, and population on \\aax",
                        min(which(df_parameters$par_type == "aa")),
                        max(which(df_parameters$par_type == "aa")),
                        escape = FALSE) |>
  kableExtra::pack_rows("effects of native light habitat on population-level \\aax",
                        min(which(df_parameters$par_type == "ppfd_aa")),
                        max(which(df_parameters$par_type == "ppfd_aa")),
                        escape = FALSE)

```

# This was the old description based on custom model

#### \agcurve{} curve parameters

We modeled \logA as a quadratic function of \loggsw for each leaf using the following equation:

$$\log(A_{ij}) = (\beta_0 + b_{0,j}) + (\beta_1 + b_{1,j}) \log{g_{\text{sw},i}} + (\beta_2 + b_{2,j}) \log{g_{\text{sw},i}}^2 + \epsilon_{i}$$

where $\beta_0$, $\beta_1$, and $\beta_2$ are the average intercept, linear, and quadratic coefficients, respectively. We used diffuse normal priors with mean $0$ and standard deviation $10$ on these parameters. We estimated random effects of curve $j$ on the intercept ($b_{0,j}$), linear ($b_{1,j}$), and quadratic ($b_{2,j}$) coefficients. We assumed that the $j \times 3$ array of coefficients was multivariate normal a mean vector of $\vec{0}$ and covariance $\Sigma_\text{curve}$. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ on the log-transformed standard deviations (i.e. the diagonal of $\Sigma_\text{curve}$). We used a weakly informative $\mathrm{LJK}(2)$ prior on the correlation matrix. The off diagonal elements of $\Sigma_\text{curve}$ can be calculated from its diagonal elements and the correlation matrix.

The residuals $\epsilon_{i}$ were modeled as a lag-1 autocorrelated time-series. We further assumed that the residual standard deviation of the $j^{\text{th}}$ curve ($\sigma_{\epsilon,j}$) was inversely proportional to the leaf surface area ($S_j$) within the chamber:

$$\log (\sigma_{\epsilon,j}) = \log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}) + (6 - S_j) \beta_{S,\epsilon}$$
where $\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}$ is the minimum residual standard deviation when the $\qty{6}{\raiseto{2}\centi\meter}$ chamber is completely filled. The residual standard deviation increases on log-linear scale by $\beta_{S,\epsilon}$. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on $\log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon})$ and a weakly informative normal prior with mean $0$ and standard deviation $1$ on $\beta_{S,\epsilon}$.

#### \aax{} for each light intensity within leaf using \agcurve{} curve parameters

We estimated \aax{} for each light intensity by integrating the difference in \logA{} between the amphi and pseudohypo \agcurve{} curves over the range of \gsw{} values where the curves overlap (from $\min(\log(g_\text{sw}))$ to $\max(\log(g_\text{sw}))$). The estimate of \aax{} for the $k^{\text{th}}$ leaf at light intensity $l$ in population $m$ is:

$$\widehat{\mathrm{AA}}_{klm} = \int_{\text{min(log(}g_\text{sw}))}^{\text{max(log(}g_\text{sw}))} \text{log}\bigg(\frac{\hat{A}_\text{amphi}(x; \theta_{klm,\text{amphi})}}{\hat{A}_\text{hypo}(x; \theta_{klm,\text{hypo})}}\bigg) dx$$
where:

$$\theta_\text{amphi} \in \{\hat{b}_{0, f(\text{amphi}, k,l,m)}, \hat{b}_{1, f(\text{amphi}, k,l,m)}, \hat{b}_{2, f(\text{amphi}, k,l,m)}\}, \text{and}$$ 

$$\theta_\text{hypo} \in \{\hat{b}_{0, f(\text{hypo}, k,l,m)}, \hat{b}_{1, f(\text{hypo}, k,l,m)}, \hat{b}_{2, f(\text{hypo}, k,l,m)}\}.$$ 
The function $f : \Theta_1 \rightarrow \Theta_2$ maps the set $\Theta_1$ indexed by leaf type (amphi or pseudohypo), leaf replicate, light intensity, and population to set $\Theta_2$ indexed by individual \agcurve{} curve. This mapping is necessary because the random effects structure differs between models of \loggsw{} on \logA{} and that of models predicting \aax{} described in the next section.



##### Effects of light intensity, light treatment, and population on \aax

We tested for effects of light intensity, light treatment, population, and their interactions on \aax. All models included effects of light intensity and light treatment, as well as random effects of population and replicate within population. More complex models included interactions between light intensity and light treatment, as well as random effects of population on the effects of light intensity and light treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ for fixed effects of light intensity and treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ for the the random effect standard deviation of replicate within population. We accounted for the phylogenetic structure among the random effects of population using an Ornstein-Uhlenbeck (OU) process [@hansen_stabilizing_1997]. The expected covariance between populations $i$ and $j$ ($\text{Cov}(i, j)$ ) is:

$$\text{Cov}(i, j) = \frac{\sigma^2}{2 \alpha} \exp(-\alpha D_{ij})$$
where $\sigma^2$ is the variance of the random effect, $\alpha$ is the rate of decay of the covariance with phylogenetic distance, $D_{ij}$, the phylogenetic distance between populations $i$ and $j$. We estimated $\sigma^2 / (2 \alpha)$ and $\alpha$ as a separate parameters and reparameterized them as $\sigma^2$ and $\alpha$. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. 

We modeled the residual standard deviation of \aax, (i.e. phylogenetically unstructured variation unaccounted for by explanatory variables) on a log-link scale with effects of light intensity and light treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on the residual standard deviation intercept and a weakly informative normal prior with mean $0$ and standard deviation $1$ on the effects of light intensity and light treatment on the residual standard deviation.

##### Effects of native light habitat on population-level \aax

We tested a linear effect of native light habitat on population-level \aax. In Models 1 and 2, we used the random intercept of \aax{} as a response variable; in model 3 we used the random intercept plus the random effect of population at high light intensity; in model 4 we used the random intercept plus the random effect of population in the sun treatment; in model 5 we used the random intercept plus the random effects of population at high light intensity and sun treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ for the slope and intercept. We accounted for the phylogenetic structure among the model residuals using an (OU) process. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. 

## note on LOOIC

We considered models with two standard errors of the mean lower LOOIC value to be a better fit to the data; we considered models with LOOIC values within two standard errors of the mean to be have similar support.