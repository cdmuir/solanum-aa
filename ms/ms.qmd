---
title: Unknown
format:
  pdf:
    keep-tex: true  
    toc: false
header-includes: |
  \usepackage{hyperref}
  \addtokomafont{disposition}{\rmfamily}
  \usepackage{siunitx}
  \newcommand{\aax}{$\mathrm{AA}$}
  \newcommand{\Aamphi}{$A_{\mathrm{amphi}}$}
  \newcommand{\Ahypo}{$A_{\mathrm{hypo}}$}
  \newcommand{\agcurve}{$A \textendash g_\text{sw}$}
  \newcommand{\aqcurve}{$A \textendash Q$}
  \newcommand{\ca}{$C_\mathrm{a}$}
  \newcommand{\caequals}[1]{$C_\mathrm{a} = \qty{#1}{\micro\mol\raiseto{-1}\mol}$}
  \newcommand{\cabetween}[2]{#1 < $C_\mathrm{a} < \qty{#2}{\micro\mol\raiseto{-1}\mol}$}
  \newcommand{\gsw}{$g_\text{sw}$}
  \newcommand{\loggsw}{$\log(g_\text{sw})$}
  \newcommand{\logA}{$\log(A)$}
  \newcommand{\ppfd}{$\mathrm{PPFD}$}
  \newcommand{\ppfdequals}[1]{$\mathrm{PPFD} = \qty{#1}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$}
  \newcommand{\ppfdqty}[1]{$\qty{#1}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$}
  \newcommand{\rh}{$\mathrm{RH}$}
  \newcommand{\rhequals}[1]{$\mathrm{RH} = #1\%$}
  \newcommand{\tleafequals}[1]{$T_\mathrm{leaf} = \qty{#1}{\degreeCelsius}$}
mainfont: Times New Roman
bibliography: solanum-aa.bib
csl: https://www.zotero.org/styles/science
---

```{r load-objects, echo=FALSE, eval=TRUE}

library(readr)
library(stringr)
library(tibble)

# I am mostly putting placeholders here for objects/values that will need to be
# loaded eventually to use in paper.
aa_args = read_rds("../objects/aa_args1.rds")
aa_stats = read_rds("../objects/aa_stats.rds")
# sort list by name
aa_stats = aa_stats[order(names(aa_stats))]

fit_aa = read_rds("../objects/fit_dummy.rds")
dim_fit_aa = dim(fit_aa$fit)

n_plant = 600
n_acc = 30
mean_n_rep = 10 # average number of individual replicates for accession per light treatment

n_weeks = 80 # number of weeks for LICOR measurements
start_licor_date = "May 1, 2022"
end_licor_date = "October 31, 2023"

# environmental condition in germination room
germ_temp_day = 25
germ_temp_night = 20
germ_rh_day = 40
germ_rh_night = 60
germ_ppfd = 200

ppfd_sun = 800
ppfd_shade = 125
temp_diff = 1 # degrees warmer that the sun treatment air was
rh_diff = 5 # rh_sun - rh_shade
leaf_temp_diff = 1 # difference in leaf temperature between treatments
n_leaf_temp = 600 # number of leaves for which we have measured leaf temp under ambient conditions

percent_terminal = "70.0" # percent of LICOR measurements on terminal leaflet
percent_lateral = "30.0"
percent_change_leaflet = "10.0" # percent of time that anatomical traits were measured on different leaflet than LICOR measurements
percent_aa_and_aq = "90.0" # percent of times where AA and AQ curves were done on same leaflet
p_red_high = "97.7" # percent red LED in high light-intensity treatment
p_blue_high = "2.3"
p_red_low = "87.0"
p_blue_low = "13.0"

percent_lma_switch = "5.0" # percent measure LMA on alternate leaflet
percent_lma_missing = "3.0" # percent leaves missing LMA

### Cleaning RH curves
n_rh_curve_raw = 2400 # export from adaptive-amphistomy/r/07_process-licor.R
n_points_per_rh_curves_raw = 100 # export from adaptive-amphistomy/r/07_process-licor.R
ca_min = aa_args$ca_min
ca_max = aa_args$ca_max
n_min_points_per_rh_curve = aa_args$n_min_points_per_rh_curve
point_outlier_threshold = aa_args$point_outlier_threshold
aa_outlier_threshold = aa_args$aa_outlier_threshold
thinning_interval = aa_args$thinning_interval
aq_r2_threshold = aa_args$aq_r2_threshold

```

## Notes

In preamble: - short codes for commonly used symbols - ?

Terminology to standardize:

-   the native light habitat or environment: the SPLASH paper refers to what they calculated as 'habitat' PPFD, so I am going to use that terminology

-   growth condition versus measurement conditions

-   ?

## Authors

definite: Wei Shen Lim, Dachuan Wang, Chris Muir
question: Sam McKlin, Tom Buckley

## Main

\[introduction\] Stomata are important

Stomatal ratio is important unsolved problem

Amphi leaves are more common in sunny habitats and confer a great benefit. (this pattern is also true in Solanum? could we analyze herbarium data here?)

\[maybe make distinction between amphi leaves and var in SR here since all tomato species are amphi\]

Leaves with greater stomatal density ratio are more in open, sunny habitats because they deliver the greatest benefit in those circumstances. An amphistomatous leaf increases photosynthetic carbon gain compared to an otherwise identical hypostomatous leaf by increasing conductance through the leaf intercellular airspaces and boudary layers; the additional water loss through a second boundary layer is typically small \[cites\]. We quantify this benefit as the amphistomy advantage (AA = log(Aamphi/Ahypo). Why would AA be greater in sun than shade? There are three nonmutually exclusive hypotheses that we classify as 'acclimatory', 'plastic', and 'constitutive'.

Acclimatory hypothesis: Leaves acclimated to high light intensity typically increase total leaf stomatal conductance (increased CO\$\_2\$ supply) and upregulate Rubisco activation <!--# I don't love the wording here. Is it just Rubisco activation, or are there are other things? --> (increased CO\$*2\$* demand). A one-dimensional circuit model using the Farquhar-von Caemmerer-Berry biochemical model of C\$\_3\$ photosynthesis shows that both increased stomatal conductance and Rubisco activity should increase AA, all else being equal (Supporting Information). If the acclimatory hypothesis is correct, we predict that AAhigh \> AAlow for all species regardless of native habitat or growth environment. Plants adapted to sunny, open habitats will evolve greater stomatal density ratio to take advantage of regular exposure to high light intensity.

Plastic hypothesis: Individuals of the same genotype often develop dramatically different leaves in sun and shade conditions (cite). Plastic responses are likely adaptations to optimize photosynthesis at different light intensities (cites), but changes in leaf anatomy and biochemistry could modulate AA as a byproduct. Thicker or less porous leaves, both of which are associated with high leaf mass per area (LMA), will have lower g_ias; leaves with increased total stomatal density and Rubisco concentration have greater potential CO2 supply and demand. Under the plastic hypothesis, we predict that AAsun \> AAshade for all species and light intensities. AAsun and gsmax,sun should be positively associated with native light habitat. \[transition\] We assume that genotypes adapted to sunny, open habitats will express a phenotype best adapted to that environment when leaves develop under high light intensity; genotypes adapted to shaded closed habitats may be plastic, but suboptimal for light intensities they do not regularly experience in nature.

\[conceptual figure could also show differential benefit of amphi leaves in sun/shade\]

to plants growing there. in those It has been hypothesized that amphistomy increases photosynthesis more in sunny places. Three nonmutually exclusive adaptive explanations for why amphi leaves:

Conceptual figure explaining each hypothesis

-   acclimation: greater demand, higher gs increase AA
-   developmental plasticity: light-induced changes in leaf anatomy modulate AA
-   constitutive: genetic differences in leaves adapted to different light habitats

We distinguished among these hypotheses by comparing AA among wild tomato species from different native light habitats, grown under simulated sun and shade light treatments, and measured under contrasting light intensity (Figure of hypotheses and predictions). We measured AA on `r n_plant` individual plants from `r n_acc` accessions (average of `r mean_n_rep` replicates per light treatment) using a recently developed method [@triplett_amphistomy_2024]. With this method, we directly compare the photosynthetic rate of an untreated amphistomatous leaf to that of the same leaf with gas exchange blocked through the adaxial (upper) surface by transparent plastic, which we refer to as 'pseudohypostomy'. To compare amphi- and pseudohypostomatous leaves at identical whole-leaf $g_\text{sc}$, we measure $A$ over a range of $g_\text{sc}$, inducing stomatal opening and closure by modulating humidity (see Materials and Methods for further details).

Table of directional predictions (with table summarizing results? part of conceptual figure? in supplement?)

caption: Directional predictions associated with each hypothesis explaining why amphistomy advantage (AA) might be greater for leaves in sunny, open habitats. For each hypothesis, we make predictions for how native light habitat, light treatment, and light intensity would affect AA.

|  hypothesis  | native light habitat | light treatment  | light intensity |
|:------------:|:--------------------:|:----------------:|:---------------:|
| acclimatory  | cor(PAR, AA) = 0   | AAsun = AAshade  | AA2000 \> AA150 |
|   plastic    | cor(PAR, AA) = 0 | AAsun \> AAshade | AA2000 = AA150  |
| constitutive | cor(PAR, AA) \> 0   | AAsun = AAshade  | AA2000 = AA150  |

\[add rows for when multiple hypotheses are supported simultaneously? or put that in SI?\]

\[results\] Amphistomy increases $A$ in all accessions, in both sun and shade leaves, and light intensities. We infer this from the fact that blocking gas exchange in pseudohypostomatous leaves reduced $A$ by X-X% depending on the accession, light treatment, and light intensity (Table/figure). The AA is equivalent to an X-X% change in total $g_\text{sc}$ (see SI section gs equivalency). But whereas increasing $g_\text{sc}$ would increase water loss as a necessary by-product, amphistomy can increase $A$ without any appreciable affect on transpiration.

Sun leaves from high light habitats \[not sure if htis result is true yet\] benefit the most from amphistomy because of a both developmental plasticity and constitutive differences among accessions. \[quantify difference in AA and contribution of different affects\]. Surprisingly, light intensity had a little effect... (should this be in this paragraph, or it's own?).

\[discussion\] - sun/shade has long been appreciated and this shows new trait that should be considered and that CO2 diffusion becomes major limitation

## Materials and Methods

\[this will be moved to SI eventually\]

### Accessions

We compared AA among `r n_acc` ecologically diverse accessions of wild tomato, including representatives of all described species of *Solanum* sect. *Lycopersicon* and sect. *Lycopersicoides* [@peralta_taxonomy_2008] and the cultivated tomato *S. lycopersicum* var. *lycopersicum* \autoref{tab:accessions}. Due to constraints on growth space and time, we spread out measurements over `r n_weeks` weeks from `r start_licor_date` to `r end_licor_date`. Replicates within accession were evenly spread out over this period to prevent confounding of temporal variation in growth conditions with accession. [anything else to say here? maybe explain accession selection and phylogeny?]

```{r, accessions, eval=FALSE,echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-accessions
#| tbl-cap: "Solanum accessions"

# outline of tab:accessions LA number,Species name, lat, lon, elev, SPLASH light value

# copied code from stomata-ilima to emulate
# read_rds("../processed-data/site.rds") |>
#   filter(site_code != "nnpl") |>
#   mutate(Island = case_when(
#     island == "oahu" ~ "Oʻahu",
#     island == "hawaii" ~ "Hawaiʻi"
#   )) |>
#   arrange(site_type, site) |>
#   select(Site = site, Island, Habitat = site_type, Latitude = latitude_degree,
#          Longitude = longitude_degree, `Elevation (mas)` = elevation_m) |>
#   knitr::kable(format = "latex", digits = c(rep(0, 3), 3, 3, 0),
#                booktabs = TRUE) |>
#   kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
#   kableExtra::column_spec(1, width = "4cm") |>
#   kableExtra::column_spec(2, width = "1.5cm") |>
#   kableExtra::column_spec(3, width = "1.5cm") |>
#   kableExtra::column_spec(4, width = "1.5cm") |>
#   kableExtra::column_spec(5, width = "1.5cm") |>
#   kableExtra::column_spec(6, width = "1.5cm")

```

### Plant growth conditions

In all growth spaces, we recorded $\mathrm{PPFD}$ using full spectrum quantum sensors (SQ-500-SS, Apogee Instruments, Logan, Utah, USA); we recorded temperature, RH, and [CO$_2$] using an EE894 sensor (E+E Elektronik, Engerwitzdorf, Austria) protected by a radiation shield. All environmental measurements were taken every 10 minutes from the middle of plants racks at approximately the same height as the leaves we measured. We measured leaf temperature of focal leaves prior to measurement using an infrared radiometer (SI-111-SS, Apogee Instruments, Logan, Utah, USA).

#### Germination and seedling stage

Seeds provided by the Tomato Genetics Resource Center germinated on moist paper in plastic boxes after soaking for 30-60 minutes in a 50% (volume per volume) solution of household bleach and water, followed by a thorough rinse. We transferred seedlings to cell-pack flats containing Pro-Mix BX potting mix (Premier Tech, Rivière-du-Loup, Quebec, Canada) once cotyledons fully emerged, typically within 1-2 weeks of sowing. We grew seeds and seedlings for both sun and shade treatments under the same environmental conditions (12:12 h, `r germ_temp_day`:$\qty{`r germ_temp_night`}{\degreeCelsius}$, `r germ_rh_day`:`r germ_rh_night` RH day:night cycle). LED light provided $\mathrm{PPFD} = \qty{`r germ_ppfd`}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$ (Fluence RAZRx, Austin, Texas, USA).

#### Light treatments

Seedlings were randomly assigned in alternating order within accession to the sun or shade treatment during transplanting. After seedlings established in cell-pack flats for $\approx 2$ weeks, we transplanted them to 3.78 L plastic pots containing 60% Pro-Mix BX potting mix, 20% coral sand (Pro-Pak, Honolulu, Hawaiʻi, USA), and 20% cinders (Niu Nursery, Honolulu, Hawaiʻi, USA). Percentage composition is on a volume basis. The soil mixture contained slow release NPK fertilizer following manufacturer instructions (Osmocote Smart-Release Plant Food Flower & Vegetable, The Scotts Company, Marysville, Ohio, USA). We determined pot field capacity one week after transplanting using a scale (Ohaus V12P15 Valor 1000, Parsippany, New Jersey, USA) and watered to field capacity three times per week to prevent drought stress. 

We assigned sun and shade treatment to lower and upper racks of a $\qty{1.22}{\meter} \times \qty{2.44}{\meter}$ shelving unit in a climate-controlled growth room. We assigned the sun treatment to the lower rack to limit diffuse light from reaching the shade treatment. The average daytime \ppfd{} was \ppfdqty{`r ppfd_sun`} and \ppfdqty{`r ppfd_shade`} for sun and shade treatments, respectively. To isolate the effect of light intensity from quality, we used the same LED model with the the same spectrum (Fluence SPYDR 2i, Austin, Texas, USAS), but dimmed the lights in the shade treatment. To maintain homogeneous environmental conditions other than light, we mixed air within the growth room using an air circulator (Vornado 693DC, Andover, Kansas, USA) and within racks using a miniature oscillating air circulator (Vornado Atom 1, Andover, Kansas, USA). Despite these efforts, the air in the sun treatment was on average $\qty{`r temp_diff`}{\degreeCelsius}$ warmer and the average RH was consequently `r rh_diff` lower. However, because of evaporative cooling, the leaves in the sun treatment were only $\qty{`r leaf_temp_diff`}{\degreeCelsius}$ on average ($n = `r n_leaf_temp`$ leaves).

### Leaf trait measurements

We selected a fully expanded, unshaded leaf at least six leaves above the cotyledons during early vegetative growth. This typically meant that plants had grown in light treatments for $\approx$ 4 weeks, ensuring they had time to sense and respond developmentally to the light intensity of the treatment rather than the seedling conditions [@schoch_dependence_1980]. Shade plants grew slower than sun plants, hence leaves at the same developmental stage were measured on chronologically older plants in the shade treatment. In some sun plants, we had to use leaves higher on the stem because short internodes made lower leaves inaccessible with the gas exchange equipment. We measured terminal leaflets in `r percent_terminal`\% of cases, but used the lateral leaflet closest to the terminal leaflet when it was damaged or difficult to clamp into the gas exchange chamber. When a leaflet was damaged during gas exchange measurements, we collected anatomical data from the nearest leaflet on the same leaf (`r percent_change_leaflet`)\%. We measured chlorophyll concentration index (CCI) using a chrolophyll concentration meter (MC-100, Apogee Instruments, Logan, Utah, USA) on the lamina of focal leaflets before gas exchange measurements at the same time we measured leaf temperature.

#### Amphistomy advantage

We estimated 'amphistomy advantage' (\aax) *sensu* @parkhurst_adaptive_1978, but with modifications previously described in @triplett_amphistomy_2024. \aax{} is calculated as the log-response ratio of $A$ compared at the same total \gsw:

$$\mathrm{AA} = \mathrm{log}(A_{\mathrm{amphi}} / A_{\mathrm{hypo}})$$

We measured the photosynthetic rate of an untreated amphistomatous leaf (\Aamphi) over a range of \gsw{} values. We refer to this as an \agcurve{} curve. We compared the \agcurve{} curve of the untreated leaf to the photosynthetic rate of pseudohypostomatous leaf (\Ahypo), which is the same leaf but with gas exchange through the upper surface blocked by a neutral density plastic (propafilm).

We measured \agcurve{} curves using a portable infrared gas analyzer (LI-6800PF, LI-COR Biosciences, Lincoln, Nebraska, USA). Light-acclimated plants were placed under LEDs dimmed to match their light treatment during gas exchange measurements. We estimated the photosynthetic rate ($A$) and stomatal conductance to CO$_2$ (\gsw) at ambient CO$_2$ (\caequals{415}) and \tleafequals{25.0}. The irradiance of the light source in the pseudohypo leaf was higher because the propafilm reduces transmission. To compensate for reduced transmission, we increased incident \ppfd for pseudohypo leaves by a factor 1/0.91, the inverse of the measured transmissivity of the propafilm. We also set the stomatal conductance ratio, for purposes of calculating boundary layer conductance, to 0 for pseudohypo leaves following manufacturer directions.

We collected four \agcurve{} curves per leaf, an amphi (untreated) curve and a pseudohypo (treated) curve at high light-intensity (\ppfdequals{2000}; `r p_red_high`:`r p_blue_high` red:blue) and low light-intensity (\ppfdequals{150}; `r p_red_low`:`r p_blue_low` red:blue). We always measured high light-intensity curves first because photosynthetic downregulation is faster than upregulation in these species. To control for order effects, we alternated between starting with amphi or pseudohypo leaf measurements. Unlike @triplett_amphistomy_2024, preliminary experiments with *Solanum* indicated a strong order effect in that $A$ declined in the second curve. Therefore, we made measurements over two days. On the first day, we measured high and low light-intensity curves for either amphi or pseudohypo leaves; on the second day, we measured high and low light-intensity curves on the other leaf type. 

In all cases, we acclimated the focal leaf to high light (\ppfdequals{2000}) and high relative humidity (\rhequals{70}) until $A$ and \gsw{} reach their maximum. After that, we decreased \rh{} to $\approx 10\%$ to induce rapid stomatal closure without biochemical downregulation. Hence, \Aamphi{} and \Ahypo{} were both measured at low chamber humidity after the leaf had acclimated to high humidity. All other environmental conditions in the leaf chamber remained the same. We logged data until \gsw{} reached its nadir. We then acclimated the leaf to low light (\ppfdequals{150}) and \rhequals{70} before inducing stomatal closure with low \rh and logging data as described above.

#### Light-response (\aqcurve) curves

In `r percent_aa_and_aq`\% of plants, we measured light-response (\aqcurve) curves on the same leaflets as \agcurve{} curves. However, when a leaflet was damaged during \agcurve{} curves, we used the next closest leaflet for \aqcurve{} curves. Leaves acclimated to high light-intensity (\ppfdequals{2000}), ambient CO$_2$ (\caequals{415}), \rhequals{50}, and \tleafequals{25}. After $A$ and \gsw{} stabilized, we measured $A$ at 20 light-intensity levels between $0$ and $\qty{2000}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$ in descending order.

#### Stomatal anatomy

<!-- are there any cases where we did not get stomatal anatomy data? -->

We estimated the stomatal density and size on ab- and adaxial leaf surfaces from all leaves, using guard cell length as a proxy for stomatal size since it proportional to maximum conductance [@sack_developmental_2016]. We made surface impressions of leaf lamina from the same area used for gas exchange measurements using a-silicone impression material (Zhermack elite HD+, light body, fast set, Rovigo, Italy). We applied clear nail polish to make positive replicas of the impression. After nail polish dried, we mounted replicas on a microscope slide using transparent tape [@mott_amphistomy_1991]. We digitized a portion of each leaf surface replica using a brightfield microscope (Leica DM2000, Wetzlar, Germany). We counted and measured guard cell length on all stomata using the FIJI implementation of ImageJ2 version 2.3.0 [@schindelin_fiji_2012], then divided the count by the visible leaf area ($\qty{0.890}{\raiseto{2}\milli\meter}$) to estimate stomatal density.

<!-- 
#### Internal leaf anatomy

Add information on internal leaf anatomy, if using 
-->

#### Leaf mass per area

Leaf mass per area (LMA) is the dry mass divided by the leaflet area. We scanned fresh leaflets on a flat bed scanner (Epson V600, Los Alamitos, California. USA) and measured leaflet area from digital images using the FIJI implementation of ImageJ2 version 2.3.0 [@schindelin_fiji_2012]. We dried leaves for 72 hours at $\qty{74}{\degreeCelsius}$ in a food dehydrator (Cosori CP267-FD, Vesync Co., Anaheim, California, USA) and weighed using a benchtop analytical balance (Ohaus PR64 Analytical Balance, Parsippany, New Jersey, USA). In $`r percent_lma_switch`\%$ we measured LMA on the adjacent leaflet because the focal leaflet was damaged or wilted while making surface impressions and we could not reliably estimate area. LMA data are missing from $`r percent_lma_missing`\%$ of individuals because the area or mass was not recorded at all or recorded incorrectly.

### Cleaning \agcurve{} curves

The raw data set consisted of `r prettyNum(aa_stats$n_rh_curve0, big.mark = ",")` \agcurve{} curves with an average of `r formatC(aa_stats$n_point_per_rh_curve0, digits = 3)` points per curve. Manual curation of a data set this size in a principled, consistent manner is not feasible. Therefore, we automated data cleaning using custom *R* scripts. Cleaning is divided into six sequential steps \autoref{tbl-cleaning1}.

```{r, cleaning1, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-cleaning1
#| tbl-cap: "Six sequential steps for cleaning \\agcurve{} curves. The rationale and procedure for each step are described in the text. The rightmost columns summarize the number of curves and mean number of points per curve remaining after each step. For reference, there are four possible \\agcurve{} curves per replicate: all combinations of leaf type (amphi or pseudohypo) and light intensity (high or low)."

step_description_col = c(
  "1. remove unreliable and unusable data points",
  "2. remove hysteretic portion of \\agcurve{} curves at low \\gsw{}",
  "3. remove outliers within each \\agcurve{} curve",
  "4. remove replicates with no overlap between amphi and pseudohypo \\agcurve{} curves",
  "5. thin redundant data points within each \\agcurve{} curve",
  "6. Trim extreme \\aax{} values"
)

n_curve_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_rh_curve[1-9]$")]) |>
  prettyNum(big.mark = ",")

n_point_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_point_per_rh_curve[1-9]$")])

tibble(
  `Step: description` = step_description_col,
  `Number of curves` = n_curve_col,
  `Number of points per curve` = n_point_col
) |>
  knitr::kable(format = "latex",
               align = c("l", "c", "c"),
               digits = c(0, 0, 1),
               booktabs = TRUE, escape = FALSE) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "9cm") |>
  kableExtra::column_spec(2, width = "2.5cm") |>
  kableExtra::column_spec(3, width = "2.5cm")

```


#### Remove unreliable and unusable data points

*Rationale*: Unreliable data points consisted of those where chamber [CO$_2$] was unstable and therefore measurements are not biologically meaningful. Unusable data points were those where $A < 0$ because the logarithm of a negative number is undefined.

*Procedure*: We retained data points where \cabetween{`r ca_min`}{`r ca_max`} and $A> 0$.

#### Remove hysteretic portion of \agcurve{} curves at low \gsw{}

*Rationale*: In most \agcurve{} curves, we observed a hysteretic response at low \gsw. After \gsw{} and $A$ declined simultaneously, $A$ increased slightly as \gsw{} continued to decline or stabilize, indicating some leaf acclimation to low \rh. We removed this portion of the curve to focus curve-fitting on the primary domain where $A$ increases monotonically with \gsw{}.

*Procedure*: For each curve, we removed data points after \gsw{} had reached its minimum unless there were fewer than `r n_min_points_per_rh_curve` data points remaining.

#### Remove outliers within each \agcurve{} curve

*Rationale*: Individual outliers within \agcurve{} curves, usually caused by transitory changes in chamber conditions, exert undue leverage on parameter estimates and cause bias and/or low precision in parameter estimates.

*Procedure*: We fit provisional quadratic regressions for each curve using ordinary least squares with the `lm()` function in *R*. We sequentially removed data points with an absolute external studentized residual $> `r point_outlier_threshold`$ until none remained.

#### Thin redundant data points within each \agcurve{} curve

*Rationale*: Data points closely spaced along the \agcurve{} curve provide redundant information and may be highly correlated (i.e. pseudoreplication). This occurred because data was logged at a constant temporal interval, but the rate at which \gsw{} declined was not constant. Thinning reduces parameter estimation bias toward densely sampled regions of the curve which may not be the most biologically informative.

*Procedure*: We retained the maxima and minima \gsw{} for each curve and thinned all but one point per thinning interval of $`r thinning_interval`~\log(\si{\mol\raiseto{-2}\meter\raiseto{-1}\second})$, retaining the point nearest the midpoint of the interval.

#### Remove replicates with no overlap between amphi and pseudohypo \agcurve{} curves

*Rationale*: We could not estimate \aax{} for replicates where amphi and pseudohypo \agcurve{} curves did not overlap.

*Procedure*: We removed replicates where the range of \gsw{} values for amphi and pseudohypo \agcurve{} curves did not overlap.

#### Trim extreme \aax{} values

*Rationale*: Extreme \aax{} values were likely due to measurement error or leaf damage. Since amphi and pseudohypo \agcurve{} curves are measured on consecutive days, a poor calibration or a damaged leaf could cause a large difference in $A$ between days, which would appear as an extreme \aax{} value.

*Procedure*: We provionsally estimated \aax{} for each replicate by integrating over the range of \gsw{} values where amphi and pseudohypo \agcurve{} curves overlap. In this procedure, curve parameters were provisionally estimated using ordinary least squares with the `lm()` function in *R*. We then used point estimates of \aax{} for each replicate as the response variable in a linear model with light treatment, light intensity, accession, and all interactions as explanatory variables. This model was also fit using ordinary least squares with the `lm()` function in *R*. We classified  extreme \aax{} values as those with an absolute internal studentized residual $> `r aa_outlier_threshold`$. Because these values likely indicate significant measurement error or leaf damage, we removed \agcurve{} curves at both light intensities if either was classified as extreme.

### Cleaning \aqcurve{} curves

The raw data set consisted of `r prettyNum(aa_stats$n_aq_curve0, big.mark = ",")` \aqcurve{} curves with an average of `r formatC(aa_stats$n_point_per_aq_curve0, digits = 3)`. Manual curation of a data set this size in a principled, consistent manner is not feasible. Therefore, we automated data cleaning using custom *R* scripts. Cleaning is divided into two sequential steps \autoref{tbl-cleaning2}.

```{r, cleaning2,echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-cleaning2
#| tbl-cap: "Two sequential steps for cleaning \\agcurve{} curves. The rationale and procedure for each step are described in the text. The rightmost columns summarize the number of curves and mean number of points per curve remaining after each step."

step_description_col = c(
  "1. remove outliers within each \\aqcurve{} curve",
  "2. remove \\aqcurve{} curves with poor fit"
)

n_curve_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_aq_curve[1-9]$")]) |>
  prettyNum(big.mark = ",")

n_point_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_point_per_aq_curve[1-9]$")])

tibble(
  `Step: description` = step_description_col,
  `Number of curves` = n_curve_col,
  `Number of points per curve` = n_point_col
) |>
  knitr::kable(format = "latex",
               align = c("l", "c", "c"),
               digits = c(0, 0, 1),
               booktabs = TRUE, escape = FALSE) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "9cm") |>
  kableExtra::column_spec(2, width = "2.5cm") |>
  kableExtra::column_spec(3, width = "2.5cm")

```

#### Remove outliers within each \aqcurve{} curve

*Rationale*: Individual outliers within \agcurve{} curves, usually caused by transitory changes in chamber conditions, exert undue leverage on parameter estimates and cause bias and/or low precision in parameter estimates.

*Procedure*: We fit provisional nonrectangular hyperbola [@marshall_model_1980] to each \aqcurve{} curve using nonlinear regression with the `nlsLM()` function from the *R* package **minpack.lm** version `r packageVersion("minpack.lm")` [@elzhov_minpacklm_2023]. We sequentially removed data points with an absolute external studentized residual $> `r point_outlier_threshold`$ until none remained.

#### Remove \aqcurve{} curves with poor fit

*Rationale*: \aqcurve{} curves with a poor fit to the nonrectangular hyperbola most likely indicate systematic measurement error and/or the leaf was not fully acclimated to the chamber environment. 

*Procedure*: As described above, we fit provisional nonrectangular hyperbola to each \aqcurve{} curve and calculated the model $r^2$. There was a clear break between typical curves and poorly fitting curves where $r^2 < `r aq_r2_threshold`$. We therefore removed \aqcurve{} curves with $r^2 < `r aq_r2_threshold`$.

### Data analysis

#### General points (not sure where this goes yet)

- models fit in Stan/brms
- we chose the number of chains, warmup and sampling iterations, and maximum treedepth so that parameter estimates converged ($\hat{R} < 1.01$ [@gelman_inference_1992]) and the effective sample size (ESS) for each parameter was $> 10^3$.

We fit Bayesian models with MCMC sampling in the probabilistic programming language *Stan* [@stan_development_team_stan_2023]. We used CmdStan version `r fit_aa$version$cmdstan` and **cmdstanr** version `r fit_aa$version$cmdstanr` [@gabry_cmdstanr_2023] to interface with *R* version `r getRversion()` [@r_core_team_r:_2023]. We sampled the posterior distribution from `r dim_fit_aa[2]` chains with `r dim_fit_aa[1]` iterations each after `r dim_fit_aa[1]` warmup iterations per chain. We estimated parameters and confidence intervals as the median and 95% quantile intervals of the posterior, respectively. 

#### Parameter estimation

There were four levels of parameter estimation in our analysis:

1. Estimate \agcurve{} curve parameters for each leaf
2. Estimate \aax{} for each light intensity with leaf using \agcurve{} curve parameters
3. Estimate the effects of light intensity, light treatment, and accession on \aax{} (assimilatory and plasticity hypotheses)
4. Estimate the effects of native light habitat on accession-level \aax{} (constitutive hypothesis)

Although the higher-level parameter estimates depend on the lower-level parameter estimates, we fit all models simultaneously to ensure that the uncertainty in lower-level estimates propagated to higher-level estimates. 

##### \agcurve{} curve parameters

We modeled \logA as a quadratic function of \loggsw for each leaf using the following equation:

$$\log(A_{ij}) = (\beta_0 + b_{0,j}) + (\beta_1 + b_{1,j}) \log{g_{\text{sw},i}} + (\beta_2 + b_{2,j}) \log{g_{\text{sw},i}}^2 + \epsilon_{i}$$

where $\beta_0$, $\beta_1$, and $\beta_2$ are the average intercept, linear, and quadratic coefficients, respectively. We used diffuse normal priors with mean $0$ and standard deviation $10$ on these parameters. We estimated random effects of curve $j$ on the intercept ($b_{0,j}$), linear ($b_{1,j}$), and quadratic ($b_{2,j}$) coefficients. We assumed that the $j \times 3$ array of coefficients was multivariate normal a mean vector of $\vec{0}$ and covariance $\Sigma_\text{curve}$. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ on the log-transformed standard deviations (i.e. the diagonal of $\Sigma_\text{curve}$). We used a weakly informative $\mathrm{LJK}(2)$ prior on the correlation matrix. The off diagonal elements of $\Sigma_\text{curve}$ can be calculated from its diagonal elements and the correlation matrix.

The residuals $\epsilon_{i}$ were modeled as a lag-1 autocorrelated time-series. We further assumed that the residual standard deviation of the $j^{\text{th}}$ curve ($\sigma_{\epsilon,j}$) was inversely proportional to the leaf surface area ($S_j$) within the chamber:

$$\log (\sigma_{\epsilon,j}) = \log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}) + (6 - S_j) \beta_{S,\epsilon}$$
where $\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}$ is the minimum residual standard deviation when the $\qty{6}{\raiseto{2}\centi\meter}$ chamber is completely filled. The residual standard deviation increases on log-linear scale by $\beta_{S,\epsilon}$. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on $\log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon})$ and a weakly informative normal prior with mean $0$ and standard deviation $1$ on $\beta_{S,\epsilon}$.

##### \aax{} for each light intensity with leaf using \agcurve{} curve parameters

Within the $k^{\text{th}}$ leaf, we estimated \aax{} for each light intensity by integrating the difference in \logA between the amphi and pseudohypo \agcurve{} curves over the range of \gsw{} values where the curves overlap (from $\min(\log(g_\text{sw}))$ to $\max(\log(g_\text{sw}))$). The estimate of \aax{} for the $k^{\text{th}}$ leaf at light intensity $l$ in accession $m$ is:

$$\widehat{\mathrm{AA}}_{klm} = \int_{\text{min(log(}g_\text{sw}))}^{\text{max(log(}g_\text{sw}))} \text{log}\bigg(\frac{\hat{A}_\text{amphi}(x; \theta_{klm,\text{amphi})}}{\hat{A}_\text{hypo}(x; \theta_{klm,\text{hypo})}}\bigg) dx$$
where:

$$\theta_\text{amphi} \in \{\hat{b}_{0, f(\text{amphi}, k,l,m)}, \hat{b}_{1, f(\text{amphi}, k,l,m)}, \hat{b}_{2, f(\text{amphi}, k,l,m)}\}, \text{and}$$ 

$$\theta_\text{hypo} \in \{\hat{b}_{0, f(\text{hypo}, k,l,m)}, \hat{b}_{1, f(\text{hypo}, k,l,m)}, \hat{b}_{2, f(\text{hypo}, k,l,m)}\}.$$ 
The function $f : \Theta_1 \rightarrow \Theta_2$ maps the set $\Theta_1$ indexed by leaf type (amphi or pseudohypo), leaf replicate, light intensity, and accession to set $\Theta_2$ indexed by individual \agcurve{} curve. This mapping is necessary because the random effects structure differs between models of \loggsw on \logA and that of models predicting \aax{} described in the next section.

##### Effects of light intensity, light treatment, and accession on \aax

We tested for effects of light intensity, light treatment, accession, and their interactions on \aax. All models included effects of light intensity and light treatment, as well as random effects of accession and replicate within accession. More complex models included interactions between light intensity and light treatment, as well as random effects of accession on the effects of light intensity and light treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ for fixed effects light intensity and treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ for the the random effect standard deviation of replicate within accession. We accounted for the phylogenetic structure among the random effects of accession using an Ornstein-Uhlenbeck (OU) process [@hansen_stabilizing_1997]. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. We modeled the residual standard deviation on a log-link scale with effects of light intensity and light treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on the residual standard deviation intercept and a weakly informative normal prior with mean $0$ and standard deviation $1$ on the effects of light intensity and light treatment on the residual standard deviation.

##### Effects of native light habitat on accession-level \aax

We tested a linear effect of native light habitat on accession-level \aax. In Models 1 and 2, we used the random intercept of \aax{} as a response variable; in model 3 we used the random intercept plus the random effect of accession at high light intensity; in model 4 we used the random intercept plus the random effect of accession in the sun treatment; in model 5 we used the random intercept plus the random effects of accession at high light intensity and sun treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ for the slope and intercept. We accounted for the phylogenetic structure among the model residuals using an (OU) process. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. 

WORKING HERE - TABLE OR SOMETHING SUMMARIZING MODELS?
- TABLE SUMMARIZING PARAMETERS

We estimated these parameters for each leaf using the posterior distribution of the parameters from the \agcurve{} curve fitting procedure.





#### Predictions

* Assimilatory: 
  + average AA2000 - AA150
  + among accession variation in AA2000 - AA150
* Plastic
  + average AAsun - AAshade
  + among accession variation in AAsun - AAshade
* Constitutive
  + cor(PAR, AA) at accession level
  
Reinforcing interactions (we only consider these because these are ones which could explain why amphi leaves occur in high light habitats)

* Assimilatory * Plastic (reinforcing interaction)
  + AAsun - AAshade greater at 2000 than 150
  + AA2000 - AA150 greater in sun leaves than shade leaves
  + there may be var among accessions, but not correlated with PAR
  
* Assimilatory * Constitutive (reinforcing interaction)
  + cor(AA2000, PAR) > 0; cor(AA150, PAR) = 0
  + AA2000 - AA150 varies among accessions, correlated with PAR
  
* Plastic * Constitutive (reinforcing interaction)
  + cor(AAsun, PAR) > 0; cor(AAshade, PAR) = 0
  + AAsun - AAshade varies among accessions, correlated with PAR
  
* Assimilatory * Plastic * Constitutive (reinforcing interaction)
  + AAsun - AAshade greater at 2000 than 150
  + AA2000 - AA150 greater in sun leaves than shade leaves
  + AAsun - AAshade varies among accession, correlated with PAR
  + AA2000 - AA150 varies among accession, correlated with PAR
  + cor(AAsun2000, PAR) > cor(AAsun150, PAR) and > cor(AAshade2000, PAR) and > cor(AAshade150, PAR) in nonadditive way
  
We tested competing predictions through a combination of model selection and parameter estimation from the posterior of selected models. We started with a base model that includes fixed effects of light intensity and light treatment on \aax, a random effect of accession on \aax, and a linear regression of PAR on accession-level \aax. We next compared the fit of the base model to a more complex with an interaction between light intensity and light treatment using LOOIC with the \textit{R} package **loo** version `r packageVersion("loo")` [@vehtari_practical_2017]. These comparisons allowed us to test the main predictions of each hypothesis and for a reinforcing interactions between assimilatory and plastic hypotheses (tab:predictions). However, these models cannot test predictions when there is an interaction with the constitutive hypothesis, because this hypothesis posits accession-levels variation in responses to light intensity and/or light treatment. Therefore, we tested for significant variation among accessions in light intensity and light treatment by comparing LOOIC values of models with and without random interactions between these factors and accession.

| Hypothesis   | Prediction | Model |
|--------------|------------|------------------|
| Assimilatory |  | base model |
| Plastic      |  | base model |
| Constitutive |  | base model |
| Assimilatory * Plastic |  | + intensity $\times$ treatment |
| Assimilatory * Constitutive |  | + accession $\times$ intensity (random) |
| Plastic * Constitutive |  | + accession $\times$ treatment (random) |
| Assimilatory * Plastic * Constitutive |  | + accession $\times$ intensity $\times$ treatment (random) |

## Acknowledgements

Justin Alter, Max Gatlin, Joana Kim, Jenna Matsuyama, Brandon Najarian, Kai Yasuda


## References