---
title: Unknown
format:
  pdf:
    keep-tex: true  
    toc: true
number-sections: true
header-includes: |
  \usepackage{hyperref}
  \addtokomafont{disposition}{\rmfamily}
  \usepackage{siunitx}
  \newcommand{\aax}{$\mathrm{AA}$}
  \newcommand{\Aamphi}{$A_{\mathrm{amphi}}$}
  \newcommand{\Ahypo}{$A_{\mathrm{hypo}}$}
  \newcommand{\agcurve}{$A \textendash g_\text{sw}$}
  \newcommand{\aqcurve}{$A \textendash Q$}
  \newcommand{\ca}{$C_\mathrm{a}$}
  \newcommand{\caequals}[1]{$C_\mathrm{a} = \qty{#1}{\micro\mol\raiseto{-1}\mol}$}
  \newcommand{\cabetween}[2]{#1 < $C_\mathrm{a} < \qty{#2}{\micro\mol\raiseto{-1}\mol}$}
  \newcommand{\gmaxratio}{$g_\text{max,ratio}$}
  \newcommand{\gsw}{$g_\text{sw}$}
  \newcommand{\loggsw}{$\log(g_\text{sw})$}
  \newcommand{\logA}{$\log(A)$}
  \newcommand{\ppfd}{$\mathrm{PPFD}$}
  \newcommand{\ppfdequals}[1]{$\mathrm{PPFD} = \qty{#1}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$}
  \newcommand{\ppfdqty}[1]{$\qty{#1}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$}
  \newcommand{\rh}{$\mathrm{RH}$}
  \newcommand{\rhequals}[1]{$\mathrm{RH} = #1\%$}
  \newcommand{\tleafequals}[1]{$T_\mathrm{leaf} = \qty{#1}{\degreeCelsius}$}
mainfont: Times New Roman
bibliography: solanum-aa.bib
csl: https://www.zotero.org/styles/science
---

```{r load-objects, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(readr)
library(stringr)
library(tibble)

source("../r/functions.R")

# I am mostly putting placeholders here for objects/values that will need to be
# loaded eventually to use in paper.
# See code in 'solanum-aq' which can probably be reused here.
aa_args = read_rds("../objects/aa_args1.rds")
aa_stats = read_rds("../objects/aa_stats.rds")
# sort list by name
aa_stats = aa_stats[order(names(aa_stats))]

plant_info = read_rds("../data/plant-info.rds")

fit_aa = read_rds("../objects/fit_dummy.rds")
dim_fit_aa = dim(fit_aa$fit)

n_plant = 600
n_acc = 30
mean_n_rep = 10 # average number of individual replicates for accession per light treatment

n_weeks = 80 # number of weeks for LICOR measurements
start_licor_date = "May 1, 2022"
end_licor_date = "October 31, 2023"

# Environmental data
df_germ_summary = read_rds("../data/df_germ_summary.rds") |>
  ungroup() |>
  summarize(value = median(value), .by = c("period", "variable", "parameter"))

df_growth_summary = read_rds("data/df_growth_summary.rds") |>
  ungroup() |>
  filter(!is.na(value)) 

# environmental condition in germination room

germ_temp_day = df_germ_summary |>
  filter(period == "day", variable == "degC", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)
  
germ_temp_night = df_germ_summary |>
  filter(period == "night", variable == "degC", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

germ_rh_day = df_germ_summary |>
  filter(period == "day", variable == "RH", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

germ_rh_night = df_germ_summary |>
  filter(period == "night", variable == "RH", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

germ_ppfd = df_germ_summary |>
  filter(period == "day", variable == "PAR", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

# environmental conditions in growth room

d1 = df_growth_summary |>
  summarize(value = median(value),
            .by = c("period", "rack", "variable", "parameter"))

ppfd_sun = d1 |>
  filter(period == "day", rack == "lower", variable == "PAR", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

ppfd_shade = d1 |>
  filter(period == "day", rack == "upper", variable == "PAR", parameter == "mu") |>
  pull(value) |>
  prettyNum(digits = 3)

# degrees warmer that the sun treatment air was
temp_diff = df_growth_summary |>
  filter(period == "day", rack != "hobo", variable == "degC", parameter == "mu") |>
  pivot_wider(names_from = "rack") |>
  mutate(diff = lower - upper) |>
  summarize(value = median(diff, na.rm = TRUE)) |>
  pull(value) |>
  prettyNum(digits = 3)

# difference in RH
rh_diff = df_growth_summary |>
  filter(period == "day", rack != "hobo", variable == "RH", parameter == "mu") |>
  pivot_wider(names_from = "rack") |>
  mutate(diff = upper - lower) |>
  summarize(value = median(diff, na.rm = TRUE)) |>
  pull(value) |>
  prettyNum(digits = 3)

df_leaf_temp = plant_info |>
  filter(!is.na(leaf_temperature_C)) |>
  summarize(
    leaf_temperature_C = mean(leaf_temperature_C),
    n = n(),
    .by = "light_treatment"
  )

# difference in leaf temperature between treatments
leaf_temp_diff = df_leaf_temp$leaf_temperature_C |>
  diff() |>
  prettyNum(digits = 3) 

# number of leaves for which we have measured leaf temp under ambient conditions
n_leaf_temp = sum(df_leaf_temp$n)

# data on leaflet type
df_leaflet_type = plant_info |>
  summarize(n = n(), .by = "leaflet") |>
  pivot_wider(names_from = "leaflet", values_from = "n") |>
  mutate(
    percent_terminal = prettyNum(terminal / (terminal + lateral) * 100, digits = 3),
    percent_lateral = prettyNum(lateral / (terminal + lateral) * 100, digits = 3)
  )

percent_terminal = df_leaflet_type$percent_terminal
percent_lateral = df_leaflet_type$percent_lateral
percent_change_leaflet = "10.0" # percent of time that anatomical traits were measured on different leaflet than LICOR measurements
percent_aa_and_aq = "90.0" # percent of times where AA and AQ curves were done on same leaflet

# data on chamber light conditions
p_red_high = "97.7" # percent red LED in high light-intensity treatment
p_blue_high = "2.3"
p_red_low = "87.0"
p_blue_low = "13.0"

percent_lma_switch = "5.0" # percent measure LMA on alternate leaflet
percent_lma_missing = "3.0" # percent leaves missing LMA

### Cleaning RH curves
n_rh_curve_raw = 2400 # export from adaptive-amphistomy/r/07_process-licor.R
n_points_per_rh_curves_raw = 100 # export from adaptive-amphistomy/r/07_process-licor.R
ca_min = aa_args$ca_min
ca_max = aa_args$ca_max
n_min_points_per_rh_curve = aa_args$n_min_points_per_rh_curve
point_outlier_threshold = aa_args$point_outlier_threshold
aa_outlier_threshold = aa_args$aa_outlier_threshold
thinning_interval = aa_args$thinning_interval
aq_r2_threshold = aa_args$aq_r2_threshold

### Cleaning AQ curves

### Bayesian data analysis
n_model = 5 |>
  number_to_word()

```

## Notes

Terminology to standardize:

-   the native light habitat or environment: the SPLASH paper refers to what they calculated as 'habitat' PPFD, so I am going to use that terminology

-   growth condition versus measurement conditions

-   ?

## Authors

definite: Wei Shen Lim, Dachuan Wang, Chris Muir

question: Sam McKlin, Tom Buckley

I am using this approach to drafting the paper:

https://blogs.nature.com/nyc/2011/08/10/how-to-write-a-paper-one-possible-answer

## Punchline

Plastic changes in the structure of sun leaves can increase the intercellular CO$_2$ diffusion path length. Gas exchange through stomata on both upper and lower leaf surfaces, amphistomy, may be a compensatory mechanism to reduce the impact of increased diffusion path length on photosynthesis without increasing water loss. We demonstrate for the first time that sun leaves benefit most from amphistomy because it compensates for plastic structural changes in leaf anatomy.

## Figures

1. competing hypotheses and predictions (or predictions after methods?) for the benefit of amphistomy
2. design of experiment to test competing hypotheses (with actual #'s of replicate, curves, etc.)
3. Results on acclimatory, plastic, constitutive hypotheses
4. Additional supporting figure on change in LMA, reduction of Amass, and relationship between LMA and AA? Modeling?

## Abstract

(use for GRC)

Developmental plasticity to light intensity modulates amphistomy advantage

The presence of stomata on both leaf surfaces (amphistomy) can increase photosynthesis in C$_3$ plants by reducing the path length for CO$_2$ diffusion between substomatal cavities and chloroplasts. Amphistomatous leaves are most common among herbaceous plants growing in sunny habitats, including many crop species. The distribution of amphistomatous leaves in nature may result from an increased photosynthetic benefit of amphistomy under high light intensity, either because of acclimatory, plastic, or constitutive variation in CO$_2$ supply or demand. We used a recently developed method to quantify amphistomy advantage, the photosynthetic rate of an amphistomatous leaf relative to an otherwise identical hypostomatous leaf, in 29 diverse populations representing 15 species of wild tomatoes (*Solanum* sect. *Lycopersicon* and sect. *Lycopersicoides*). Plant grown under high light intensity benefit more from amphostomy than those grown under low light, regardless of acclimation or native light intensity. Curvature of light response curves indicates that high-light leaves benefit more from amphistomy because of greater resistance to CO$_2$ diffusion within the mesophyll. Developmental plasticity in leaf thickness and/or cell arrangement to optimize light interception likely increases under varying light intensity modulates CO$_2$ diffusion within the leaf and, hence, amphistomy advantage as a byproduct. Developmental plasticity may therefore play an important and previously unnoticed role in explaining the adaptive significance of amphistomy and the distribution of amphistomatous leaves in nature.

What's surprising: role of developmental plasticity in explaining comparative results; diffusional limitations through palisade ias is strong and needs to be considered with light gradients in understanding leaf strucuture- funciton

## Intro

<!-- Paragraph 1 -->
Stomata are microscopic pores on the surfaces of leaves and other photosynthetic organs formed by a pair of guard cells. They are essential for balancing carbon gained per unit water lost and permitted vascular plants to grow tall on land by enabling access to CO$_2$ for photosynthetic carbon assimilation while preventing hydraulic failure in variable environments [@raven_selection_2002; @mccadam_stomata_2021; @clark_origin_2022]. Optimal stomatal function depends on both dynamic changes in aperture on the scale of minutes to hours, as well as static anatomy determined by developmental plasticity and constitutive genetic differences [@hetherington_role_2003; @boer_optimal_2016; @harrison_influence_2020]. Understanding how stomata respond to environmental change over daily, developmental, and evolutionary time is important for understanding adaptation [@woodward_stomatal_1987; @buckley_modeling_2013; @raven_selection_2002; @haworth_coordination_2013; @liang_stomatal_2023; @chua_stomatal_2024; @lang_century_2024], predicting paleoclimate from fossil cuticles [@franks_new_2014; @mcelwain_paleoecology_2017; @honisch_toward_2023], and improving crops [@hofmann_impact_2025]. Stomatal function contributes to global carbon and water cycles [@berry_stomata_2010] and therefore predicting future climate [@franks_stomatal_2017].

<!-- Paragraph 2 -->
Despite extensive theoretical and empirical progress understanding stomata function and anatomy from molecular to ecosystem levels, the adaptive significance of amphistomatous leaves remains an important unsolved problem in leaf structure-function relationships [@grubb_leaf_1977; @parkhurst_adaptive_1978; @mott_adaptive_1982;@gibson_structure_1996; @oguchi_leaf_2018; @drake_two_2019; @grubb_leaf_2020]. Amphistomatous leaves develop abaxial and adaxial stomata that can be independently regulated [@pospisilova_stomatal_1980; @mott_stomatal_1984; @reich_effects_1985; @mott_asymmetric_1993; @wall_stomata_2022] to allow gas exchange through each surface. In theory, gas exchange through stomata on each surface increases CO$_2$ supply to chloroplasts, all else being equal, enhancing photosynthesis [@parkhurst_adaptive_1978; @gutschick_photosynthesis_1984]. Amphistomatous leaves also lose more water through evaporation because of a second boundary layer conductance (Smith), but the additional carbon gain should be enough to offset this cost in most realistic scenarios (Muir 2019). 

<!-- Paragraph 3 -->
<!-- Need to mention here or in previous grafs, estimates of r_ias Mott & Oleary 1984; Marquez et al., etc. -->
<!-- "Farquhar and Raschke (2). However, using a technique similar to ours, Sharkey et al. (11) estimate r, in Xan:hium to be closer to 1.0 m2 s mol-', and state that they believe the estimate of 3.2 m2 s mol-' to be high" -->

The paradoxical fact is that, despite the potential photosynthetic benefit, most leaves are not amphistomatous. Many vertically oriented and/or isobilateral leaves are amphistomatous (arcto paper, drake). But among dorsiventral leaves, herbaceous plants in open, high light habitats tend to have have amphistomatous leaves (salisbury, bucher, jordan, etc.). Most other leaves, except those from aquatic habitats, are hypostomatous, producing stomata only on the lower, abaxial surface. Even resupinate leaves develop stomata on the lower, albeit adaxial surface (Lesheyde?), suggesting that leaf orientation (lower vs. upper) rather than leaf polarity (abaxial vs. adaxial) is causal. The covariation between stomatal density ratio and light habitat is both qualitative and quantitative. A higher proportion of sun leaves are amphistomatous (salisbury) and the proportion of stomata on the upper, adaxial surface increases with light (muir 2018, bucher?). Resolving why high light intensity favors amphistomatous dorsivental leaves is an important first step toward understanding variation in stomatal density ratio and leaf structure-function relationships more generally.

<!-- Paragraph 4+, hypotheses and predictions -->
The overarching hypothesis is that leaves with greater stomatal density ratio are more common in open, sunny habitats because they increase photosynthesis most in those circumstances. An amphistomatous leaf increases photosynthetic carbon gain compared to an otherwise identical hypostomatous leaf by increasing conductance through the leaf intercellular airspaces and boudary layers; the additional water loss through a second boundary layer is typically small (smith paper, muir 2019). We quantify this benefit as the amphistomy advantage (AA = log(Aamphi/Ahypo) (Parkhurst, Triplett). Why would AA be greater in sun than shade? We consider three nonmutually exclusive hypotheses that we classify as 'acclimatory', 'plastic', and 'constitutive'.

Acclimatory hypothesis: Photosynthetic induction to high light intensity typically involves increases in total leaf stomatal conductance (increased CO\$\_2\$ supply), the concentration of active Rubisco, and electron transport capacity (increased CO\$*2\$* demand). A one-dimensional circuit model using the Farquhar-von Caemmerer-Berry biochemical model of C\$\_3\$ photosynthesis shows that both increased stomatal conductance and Rubisco activity should increase AA, all else being equal (Supporting Information). If the acclimatory hypothesis is correct, we predict that AAhigh \> AAlow for all species regardless of native habitat or growth environment. Plants adapted to sunny, open habitats will evolve greater stomatal density ratio to take advantage of regular exposure to high light intensity.

Plastic hypothesis: Individuals of the same genotype often develop dramatically different leaves in sun and shade conditions (cite). Plastic responses are likely adaptations to optimize photosynthesis at different light intensities in variable environments (cites). Plastic changes in leaf anatomy and biochemistry could modulate AA as a byproduct. Thicker or less porous leaves, both of which are associated with high leaf mass per area (LMA), will have lower $g_\mathrm{ias}$; leaves with increased total stomatal density and photosynthetic capacity have greater potential CO$_2$ supply and demand. Under the plastic hypothesis, we predict that AAsun \> AAshade for all species and light intensities. Secondarily, AAsun and gsmax,sun should also be positively associated with native light habitat if genotypes adapted to sunny, open habitats if they can express a phenotype best adapted to that environment when leaves develop under high light intensity. Genotypes adapted to shaded, closed habitats may be plastic, but limits on the width of their reaction norms prevent them from developing traits optimal for conditions they do not regularly experience in nature.

Constitutive hypothesis: In environments that are relatively constant or where environmental change cannot be anticipated by a reliable cue, natural selection will favor constitutive expression of optimal phenotypes. We therefore predict genotypes from more sunny, open habitats will have consistently greater AA under also measurement and growth light intensities. For herbaceous plants, light intensity is largely a function of the tree canopy (cites?). Herbs growing in the open will regularly experience high light intensity; herbs growing under a forest canopy will often experience low light intensity.

The primary directional predictions for each hypothesis are summarized in Table X; detailed predictions for results that would indicate support for multiple hypotheses are in Table SX.

CONCEPTUAL FIGURE HERE

caption: Directional predictions associated with each hypothesis explaining why amphistomy advantage (AA) might be greater for leaves in sunny, open habitats. For each hypothesis, we make predictions for how native plant area index (PAI), growth light treatment, and measurement light intensity would affect AA.

|  hypothesis  | measurement light intensity | growth light intensity  | native PAI |
|:------------:|:---------------------------:|:------------------------:|:----------:|
| acclimatory  | AA2000 > AA150             | AAsun = AAshade          | cor(PAI, AA) = 0 |
| plastic      | AA2000 = AA150             | AAsun > AAshade          | cor(PAI, AA) = 0 |
| constitutive | AA2000 = AA150             | AAsun = AAshade          | cor(PAI, AA) > 0 |

<!-- Paragraph 5 (summarize methods) -->
We tested these hypotheses by comparing AA among amphistomatous wild tomato species (systematic cites) from different native light habitats, grown under simulated sun and shade light treatments, and measured under contrasting light intensity (Figure of hypotheses and predictions). We measured AA on `r n_plant` individual plants from `r n_acc` accessions (average of `r mean_n_rep` replicates per light treatment) using a recently developed method [@triplett_amphistomy_2024]. With this method, we directly compare the photosynthetic rate of an untreated amphistomatous leaf to that of the same leaf with gas exchange blocked through the adaxial (upper) surface by transparent plastic, which we refer to as 'pseudohypostomy'. To compare amphi- and pseudohypostomatous leaves at identical whole-leaf $g_\text{sc}$, we measure $A$ over a range of $g_\text{sc}$, inducing stomatal opening and closure by modulating humidity (see Materials and Methods for further details). We estimated 'amphistomy advantage' (\aax) *sensu* @parkhurst_adaptive_1978, but with modifications previously described in @triplett_amphistomy_2024 and here (Materials and Methods). The native light intensity was represented by plant area index (PAI $\unit{\meter\squared\per\meter\squared}$), estimated using a global gridded X-m2 resolution data set derived from the Global Ecosystem Dynamics Investigation (GEDI; cite) and georeferenced accession collection information (cite TGRC). The growth light intensities were `r ppfd_sun` (sun treatment) and `r ppfd_shade` (shade treatment) while all other environment conditions were nearly identical (see @sec-methods for supporting detail). The high and low measurements intensities were \ppfdequals{2000} (`r p_red_high`:`r p_blue_high` red:blue) and \ppfdequals{150} (`r p_red_low`:`r p_blue_low` red:blue), respectively. 

<!-- Paragraph 6 (summarize main results) -->
Consistent with biophysical theory of CO2 diffusion within leaves, AA > 0 for all accessions (Figure X). AA varied substantially between measurement light intensities, growth light intensities, and among accessions (point to model comparison evidence). Measured under high light intensity, AA was consistently greater for sun plants. The average AA among accessions in the shade treat was X (X of 29 accessions significantly greater than 0); however, the same accessions grown at high light intensity had an AA of X (X of 29 accession greater than 0). Contrary to the predictions of the assimilatory hypothesis, AA was consistently greater under low measurement light intensity. Among sun and shade grown plants, AA was greater under low light intensity in X of 29 accessions (significantly greater than 0 in X of 29 accessions). The overall average AA of shade and sun grown plants measured under low light intensity was X (+/-) and X (+/-), respectively. There was a slight tendency for accessions from more closed habitats (greater PAI), but AA varied widely among accessions from open habitats (low PAI) regardless of growth and measurement light intensities (Figure X). The pattern of AA across wild tomatoes strongly supports the plasticity hypothesis, argues against the acclimatory hypothesis, and provides only weak support for the constitutive hypothesis. 
Not sure where this goes: We infer this from the fact that blocking gas exchange in pseudohypostomatous leaves reduced $A$ by X-X% depending on the accession, light treatment, and light intensity (Table/figure). The AA is equivalent to an X-X% change in total $g_\text{sc}$ (see SI section gs equivalency). But whereas increasing $g_\text{sc}$ would increase water loss as a necessary by-product, amphistomy can increase $A$ without any appreciable affect on transpiration.


<!-- Paragraph 7 (summarize secondary results) -->
These results suggest that developmental plasticity, as opposed to acclimation or adaptation to open habitats, may explain the explain the long-standing observation taht amphistomatous leaves are more common in sunny habitats. Our results add to existing explanations by showing high light intensity *per se* does not increase the benefit of amphistomy, but rather than anatomical and biochemical change associated with higher light intensity modulate AA. We cannot yet attribute specific changes wrought by plasticity, but correlational evidence suggests that changes in leaf anatomy may be important. Species responded consistently by increasing stomatal density, especially on the adaxial surface, increasing stomatal density ratio. Sun leaves also had greater gs, Amax. However, these traits were not associated with change in AA (table/figures).

from Mott and Oleary: "However, Jones and Slatyer (5) reported a higher mesophyll resistance for CO, entering through the upper stomata than for the lower, and the data of Vaclavik (12) appear to support this conclusion"


## Outtro - I think this goes at the end??
It is commonly assumed in comparative studies that most trait variation between species is constitutive and genetically determined, but our results suggest that plastic responses to light are necessary to explain why \gmaxratio{} increases with light habitat. Reaction norms to light intensity among wild tomatoes indicate that accessions from low light habitats express low \gmaxratio{} when grown in shade, whereas accessions from high light habitats have constitutively higher \gmaxratio{} (Fig. rxn-norm). The larger response to light intensity is driven by greater plasticty in leaf structure in accessions from low-light habitats (Fig/table - I haven't tested this yet, so this is a placeholder.) We infer that these structural changes in sun leaves are costly because they increase the diffusion path length for CO$_2$ and reduce photosynthesis. As a consequence, sun leaves benefit more from amphistomy. This is the first demonstration that sun leaves benefit more from amphistomy because it compensates for developmental plasticity in leaf structure.

Two outstanding areas for further research are 1) the specific anatomical changes, such as leaf thickness or mesophyll porosity, that increase the diffusion path length for CO$_2$ in sun leaves, and 2) the costs of amphistomy that could explain plasticity in \gmaxratio{} in accessions from low-light habitats. Resolving the first question will require detailed anatomical measurements on a large number of shade and sun leaves with concomitant estimates of \aax. The fact that accessions from low-light habitats are more plastic suggests that costs of amphistomy are greatest in these environments. (not finished yet)

Problems to bring up in discussion:
- all our species were amphi, so they may all live in PAI below threshold to favor amphi
- other microclimate diffs not considered
- don't know specific anatomical change

8. What it all means
  * Our study reveals an important role for plasticity in explaining why amphi leaves are more common in sunny habitats
  * Confirms that leaf structure of sun leaves incurs costs that amphistomy can mitigate
  * It will be useful to consider coordination between leaf anatomy, stomatal density, and ratio in future studies of leaf structure-function and in crops (or something)

## Materials and Methods [#sec-methods]

\[this will be moved to SI eventually. note that much of it also the same in solanum-aq project, so might change to cite that paper?\]

(not sure where this goes)  * We acclimated the focal leaf to high light (\ppfdequals{2000}) and high relative humidity (\rhequals{70}) until $A$ and \gsw{} reach their maximum. After that, we decreased \rh{} to $\approx 10\%$ to induce rapid stomatal closure without biochemical down

### Accessions

We compared AA among `r n_acc` ecologically diverse accessions of wild tomato, including representatives of all described species of *Solanum* sect. *Lycopersicon* and sect. *Lycopersicoides* [@peralta_taxonomy_2008] and the cultivated tomato *S. lycopersicum* var. *lycopersicum* \autoref{tab:accessions}. Due to constraints on growth space and time, we spread out measurements over `r n_weeks` weeks from `r start_licor_date` to `r end_licor_date`. Replicates within accession were evenly spread out over this period to prevent confounding of temporal variation in growth conditions with accession. [anything else to say here? maybe explain accession selection and phylogeny?]

```{r, accessions, eval=TRUE,echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-accessions
#| tbl-cap: "Accessions of *Solanum* used in this study. The species name, accession number, collection latitude, longitude, elevation, and daily solar radiation estimated using the SPLASH algorithm (see 'Climate data'). TGRC: Tomato Genetics Resource Center; PPFD: Photosynthetic Photon Flux Density."

# Copied from solanum-aq project

accession_info = read_rds("../data/accession-info.rds") |>
  filter(accession %in% light_curves$acc) |>
  left_join(read_rds("../data/accession-climate.rds") |>
              select(accession, ppfd_mol_m2), by = join_by(accession)) |>
  arrange(species, accession) |>
  select(
    Species = species,
    `TGRC accession` = accession,
    `Latitude` = lat,
    `Longitude` = lon,
    `Elevation (mas)` = elev,
    `$\\mathrm{PPFD}~(\\mathrm{mol}~\\mathrm{m}^2)$` = ppfd_mol_m2
  )

accession_info |>
  knitr::kable(
    format = "latex",
    digits = c(rep(0, 2), 3, 3, 0, 1),
    booktabs = TRUE,
    longtable = TRUE,
    escape = FALSE
  ) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "3.25cm", italic = TRUE)

```

### Plant growth conditions

In all growth spaces, we recorded $\mathrm{PPFD}$ using full spectrum quantum sensors (SQ-500-SS, Apogee Instruments, Logan, Utah, USA); we recorded temperature, RH, and [CO$_2$] using an EE894 sensor (E+E Elektronik, Engerwitzdorf, Austria) protected by a radiation shield. All environmental measurements were taken every 10 minutes from the middle of plants racks at approximately the same height as the leaves we measured. We measured leaf temperature of focal leaves prior to measurement using an infrared radiometer (SI-111-SS, Apogee Instruments, Logan, Utah, USA).

#### Germination and seedling stage

Seeds provided by the Tomato Genetics Resource Center germinated on moist paper in plastic boxes after soaking for 30-60 minutes in a 50% (volume per volume) solution of household bleach and water, followed by a thorough rinse. We transferred seedlings to cell-pack flats containing Pro-Mix BX potting mix (Premier Tech, Rivière-du-Loup, Quebec, Canada) once cotyledons fully emerged, typically within 1-2 weeks of sowing. We grew seeds and seedlings for both sun and shade treatments under the same environmental conditions (12:12 h, `r germ_temp_day`:$\qty{`r germ_temp_night`}{\degreeCelsius}$, `r germ_rh_day`:`r germ_rh_night` RH day:night cycle). LED light provided $\mathrm{PPFD} = \qty{`r germ_ppfd`}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$ (Fluence RAZRx, Austin, Texas, USA).

#### Light treatments

Seedlings were randomly assigned in alternating order within accession to the sun or shade treatment during transplanting. After seedlings established in cell-pack flats for $\approx 2$ weeks, we transplanted them to 3.78 L plastic pots containing 60% Pro-Mix BX potting mix, 20% coral sand (Pro-Pak, Honolulu, Hawaiʻi, USA), and 20% cinders (Niu Nursery, Honolulu, Hawaiʻi, USA). Percentage composition is on a volume basis. The soil mixture contained slow release NPK fertilizer following manufacturer instructions (Osmocote Smart-Release Plant Food Flower & Vegetable, The Scotts Company, Marysville, Ohio, USA). We determined pot field capacity one week after transplanting using a scale (Ohaus V12P15 Valor 1000, Parsippany, New Jersey, USA) and watered to field capacity three times per week to prevent drought stress. 

We assigned sun and shade treatment to lower and upper racks of a $\qty{1.22}{\meter} \times \qty{2.44}{\meter}$ shelving unit in a climate-controlled growth room. We assigned the sun treatment to the lower rack to limit diffuse light from reaching the shade treatment. The average daytime \ppfd{} was \ppfdqty{`r ppfd_sun`} and \ppfdqty{`r ppfd_shade`} for sun and shade treatments, respectively. To isolate the effect of light intensity from quality, we used the same LED model with the the same spectrum (Fluence SPYDR 2i, Austin, Texas, USAS), but dimmed the lights in the shade treatment. To maintain homogeneous environmental conditions other than light, we mixed air within the growth room using an air circulator (Vornado 693DC, Andover, Kansas, USA) and within racks using a miniature oscillating air circulator (Vornado Atom 1, Andover, Kansas, USA). Despite these efforts, the air in the sun treatment was on average $\qty{`r temp_diff`}{\degreeCelsius}$ warmer and the average RH was consequently `r rh_diff` lower. However, because of evaporative cooling, the leaves in the sun treatment were only $\qty{`r leaf_temp_diff`}{\degreeCelsius}$ on average ($n = `r n_leaf_temp`$ leaves).

### Leaf trait measurements

We selected a fully expanded, unshaded leaf at least six leaves above the cotyledons during early vegetative growth. This typically meant that plants had grown in light treatments for $\approx$ 4 weeks, ensuring they had time to sense and respond developmentally to the light intensity of the treatment rather than the seedling conditions [@schoch_dependence_1980]. Shade plants grew slower than sun plants, hence leaves at the same developmental stage were measured on chronologically older plants in the shade treatment. In some sun plants, we had to use leaves higher on the stem because short internodes made lower leaves inaccessible with the gas exchange equipment. We measured terminal leaflets in `r percent_terminal`\% of cases, but used the lateral leaflet closest to the terminal leaflet when it was damaged or difficult to clamp into the gas exchange chamber. When a leaflet was damaged during gas exchange measurements, we collected anatomical data from the nearest leaflet on the same leaf (`r percent_change_leaflet`)\%. We measured chlorophyll concentration index (CCI) using a chrolophyll concentration meter (MC-100, Apogee Instruments, Logan, Utah, USA) on the lamina of focal leaflets before gas exchange measurements at the same time we measured leaf temperature.

#### Amphistomy advantage

We estimated 'amphistomy advantage' (\aax) *sensu* @parkhurst_adaptive_1978, but with modifications previously described in @triplett_amphistomy_2024. \aax{} is calculated as the log-response ratio of $A$ compared at the same total \gsw:

$$\mathrm{AA} = \mathrm{log}(A_{\mathrm{amphi}} / A_{\mathrm{hypo}})$$

We measured the photosynthetic rate of an untreated amphistomatous leaf (\Aamphi) over a range of \gsw{} values. We refer to this as an \agcurve{} curve. We compared the \agcurve{} curve of the untreated leaf to the photosynthetic rate of pseudohypostomatous leaf (\Ahypo), which is the same leaf but with gas exchange through the upper surface blocked by a neutral density plastic (propafilm).

We measured \agcurve{} curves using a portable infrared gas analyzer (LI-6800PF, LI-COR Biosciences, Lincoln, Nebraska, USA). Light-acclimated plants were placed under LEDs dimmed to match their light treatment during gas exchange measurements. We estimated the photosynthetic rate ($A$) and stomatal conductance to CO$_2$ (\gsw) at ambient CO$_2$ (\caequals{415}) and \tleafequals{25.0}. The irradiance of the light source in the pseudohypo leaf was higher because the propafilm reduces transmission. To compensate for reduced transmission, we increased incident \ppfd for pseudohypo leaves by a factor 1/0.91, the inverse of the measured transmissivity of the propafilm. We also set the stomatal conductance ratio, for purposes of calculating boundary layer conductance, to 0 for pseudohypo leaves following manufacturer directions.

We collected four \agcurve{} curves per leaf, an amphi (untreated) curve and a pseudohypo (treated) curve at high light-intensity (\ppfdequals{2000}; `r p_red_high`:`r p_blue_high` red:blue) and low light-intensity (\ppfdequals{150}; `r p_red_low`:`r p_blue_low` red:blue). We always measured high light-intensity curves first because photosynthetic downregulation is faster than upregulation in these species. To control for order effects, we alternated between starting with amphi or pseudohypo leaf measurements. Unlike @triplett_amphistomy_2024, preliminary experiments with *Solanum* indicated a strong order effect in that $A$ declined in the second curve. Therefore, we made measurements over two days. On the first day, we measured high and low light-intensity curves for either amphi or pseudohypo leaves; on the second day, we measured high and low light-intensity curves on the other leaf type. 

In all cases, we acclimated the focal leaf to high light (\ppfdequals{2000}) and high relative humidity (\rhequals{70}) until $A$ and \gsw{} reach their maximum. After that, we decreased \rh{} to $\approx 10\%$ to induce rapid stomatal closure without biochemical downregulation. Hence, \Aamphi{} and \Ahypo{} were both measured at low chamber humidity after the leaf had acclimated to high humidity. All other environmental conditions in the leaf chamber remained the same. We logged data until \gsw{} reached its nadir. We then acclimated the leaf to low light (\ppfdequals{150}) and \rhequals{70} before inducing stomatal closure with low \rh and logging data as described above.

#### Light-response (\aqcurve) curves

In `r percent_aa_and_aq`\% of plants, we measured light-response (\aqcurve) curves on the same leaflets as \agcurve{} curves. However, when a leaflet was damaged during \agcurve{} curves, we used the next closest leaflet for \aqcurve{} curves. Leaves acclimated to high light-intensity (\ppfdequals{2000}), ambient CO$_2$ (\caequals{415}), \rhequals{50}, and \tleafequals{25}. After $A$ and \gsw{} stabilized, we measured $A$ at 20 light-intensity levels between $0$ and $\qty{2000}{\micro\mol\raiseto{-2}\meter\raiseto{-1}\second}$ in descending order.

#### Stomatal anatomy

<!-- are there any cases where we did not get stomatal anatomy data? -->

We estimated the stomatal density and size on ab- and adaxial leaf surfaces from all leaves, using guard cell length as a proxy for stomatal size since it proportional to maximum conductance [@sack_developmental_2016]. We made surface impressions of leaf lamina from the same area used for gas exchange measurements using a-silicone impression material (Zhermack elite HD+, light body, fast set, Rovigo, Italy). We applied clear nail polish to make positive replicas of the impression. After nail polish dried, we mounted replicas on a microscope slide using transparent tape [@mott_amphistomy_1991]. We digitized a portion of each leaf surface replica using a brightfield microscope (Leica DM2000, Wetzlar, Germany). We counted and measured guard cell length on all stomata using the FIJI implementation of ImageJ2 version 2.3.0 [@schindelin_fiji_2012], then divided the count by the visible leaf area ($\qty{0.890}{\raiseto{2}\milli\meter}$) to estimate stomatal density.

<!-- 
#### Internal leaf anatomy

Add information on internal leaf anatomy, if using 
-->

#### Leaf mass per area

Leaf mass per area (LMA) is the dry mass divided by the leaflet area. We scanned fresh leaflets on a flat bed scanner (Epson V600, Los Alamitos, California. USA) and measured leaflet area from digital images using the FIJI implementation of ImageJ2 version 2.3.0 [@schindelin_fiji_2012]. We dried leaves for 72 hours at $\qty{74}{\degreeCelsius}$ in a food dehydrator (Cosori CP267-FD, Vesync Co., Anaheim, California, USA) and weighed using a benchtop analytical balance (Ohaus PR64 Analytical Balance, Parsippany, New Jersey, USA). In $`r percent_lma_switch`\%$ we measured LMA on the adjacent leaflet because the focal leaflet was damaged or wilted while making surface impressions and we could not reliably estimate area. LMA data are missing from $`r percent_lma_missing`\%$ of individuals because the area or mass was not recorded at all or recorded incorrectly.

### Cleaning \agcurve{} curves

The raw data set consisted of `r prettyNum(aa_stats$n_rh_curve0, big.mark = ",")` \agcurve{} curves with an average of `r formatC(aa_stats$n_point_per_rh_curve0, digits = 3)` points per curve. Manual curation of a data set this size in a principled, consistent manner is not feasible. Therefore, we automated data cleaning using custom *R* scripts. Cleaning is divided into six sequential steps (\autoref{tbl-cleaning1}).

```{r, cleaning1, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-cleaning1
#| tbl-cap: "Six sequential steps for cleaning \\agcurve{} curves. The rationale and procedure for each step are described in the text. The rightmost columns summarize the number of curves and mean number of points per curve remaining after each step. For reference, there are four possible \\agcurve{} curves per replicate: all combinations of leaf type (amphi or pseudohypo) and light intensity (high or low)."

step_description_col = c(
  "1. remove unreliable and unusable data points",
  "2. remove hysteretic portion of \\agcurve{} curves at low \\gsw{}",
  "3. remove outliers within each \\agcurve{} curve",
  "4. remove replicates with no overlap between amphi and pseudohypo \\agcurve{} curves",
  "5. thin redundant data points within each \\agcurve{} curve",
  "6. Trim extreme \\aax{} values"
)

n_curve_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_rh_curve[1-9]$")]) |>
  prettyNum(big.mark = ",")

n_point_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_point_per_rh_curve[1-9]$")])

tibble(
  `Step: description` = step_description_col,
  `Number of curves` = n_curve_col,
  `Number of points per curve` = n_point_col
) |>
  knitr::kable(format = "latex",
               align = c("l", "c", "c"),
               digits = c(0, 0, 1),
               booktabs = TRUE, escape = FALSE) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "9cm") |>
  kableExtra::column_spec(2, width = "2.5cm") |>
  kableExtra::column_spec(3, width = "2.5cm")

```


#### Remove unreliable and unusable data points

*Rationale*: Unreliable data points consisted of those where chamber [CO$_2$] was unstable and therefore measurements are not biologically meaningful. Unusable data points were those where $A < 0$ because the logarithm of a negative number is undefined.

*Procedure*: We retained data points where \cabetween{`r ca_min`}{`r ca_max`} and $A> 0$.

#### Remove hysteretic portion of \agcurve{} curves at low \gsw{}

*Rationale*: In most \agcurve{} curves, we observed a hysteretic response at low \gsw. After \gsw{} and $A$ declined simultaneously, $A$ increased slightly as \gsw{} continued to decline or stabilize, indicating some leaf acclimation to low \rh. We removed this portion of the curve to focus curve-fitting on the primary domain where $A$ increases monotonically with \gsw{}.

*Procedure*: For each curve, we removed data points after \gsw{} had reached its minimum unless there were fewer than `r n_min_points_per_rh_curve` data points remaining.

#### Remove outliers within each \agcurve{} curve

*Rationale*: Individual outliers within \agcurve{} curves, usually caused by transitory changes in chamber conditions, exert undue leverage on parameter estimates and cause bias and/or low precision in parameter estimates.

*Procedure*: We fit provisional quadratic regressions for each curve using ordinary least squares with the `lm()` function in *R*. We sequentially removed data points with an absolute external studentized residual $> `r point_outlier_threshold`$ until none remained.

#### Thin redundant data points within each \agcurve{} curve

*Rationale*: Data points closely spaced along the \agcurve{} curve provide redundant information and may be highly correlated (i.e. pseudoreplication). This occurred because data was logged at a constant temporal interval, but the rate at which \gsw{} declined was not constant. Thinning reduces parameter estimation bias toward densely sampled regions of the curve which may not be the most biologically informative.

*Procedure*: We retained the maxima and minima \gsw{} for each curve and thinned all but one point per thinning interval of $`r thinning_interval`~\log(\si{\mol\raiseto{-2}\meter\raiseto{-1}\second})$, retaining the point nearest the midpoint of the interval.

#### Remove replicates with no overlap between amphi and pseudohypo \agcurve{} curves

*Rationale*: We could not estimate \aax{} for replicates where amphi and pseudohypo \agcurve{} curves did not overlap.

*Procedure*: We removed replicates where the range of \gsw{} values for amphi and pseudohypo \agcurve{} curves did not overlap.

#### Trim extreme \aax{} values

*Rationale*: Extreme \aax{} values were likely due to measurement error or leaf damage. Since amphi and pseudohypo \agcurve{} curves are measured on consecutive days, a poor calibration or a damaged leaf could cause a large difference in $A$ between days, which would appear as an extreme \aax{} value.

*Procedure*: We provionsally estimated \aax{} for each replicate by integrating over the range of \gsw{} values where amphi and pseudohypo \agcurve{} curves overlap. In this procedure, curve parameters were provisionally estimated using ordinary least squares with the `lm()` function in *R*. We then used point estimates of \aax{} for each replicate as the response variable in a linear model with light treatment, light intensity, accession, and all interactions as explanatory variables. This model was also fit using ordinary least squares with the `lm()` function in *R*. We classified  extreme \aax{} values as those with an absolute internal studentized residual $> `r aa_outlier_threshold`$. Because these values likely indicate significant measurement error or leaf damage, we removed \agcurve{} curves at both light intensities if either was classified as extreme.

### Cleaning \aqcurve{} curves

The raw data set consisted of `r prettyNum(aa_stats$n_aq_curve0, big.mark = ",")` \aqcurve{} curves with an average of `r formatC(aa_stats$n_point_per_aq_curve0, digits = 3)`. Manual curation of a data set this size in a principled, consistent manner is not feasible. Therefore, we automated data cleaning using custom *R* scripts. Cleaning is divided into two sequential steps (\autoref{tbl-cleaning2}).

```{r, cleaning2,echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-cleaning2
#| tbl-cap: "Two sequential steps for cleaning \\agcurve{} curves. The rationale and procedure for each step are described in the text. The rightmost columns summarize the number of curves and mean number of points per curve remaining after each step."

step_description_col = c(
  "1. remove outliers within each \\aqcurve{} curve",
  "2. remove \\aqcurve{} curves with poor fit"
)

n_curve_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_aq_curve[1-9]$")]) |>
  prettyNum(big.mark = ",")

n_point_col = unlist(aa_stats[str_detect(names(aa_stats), "^n_point_per_aq_curve[1-9]$")])

tibble(
  `Step: description` = step_description_col,
  `Number of curves` = n_curve_col,
  `Number of points per curve` = n_point_col
) |>
  knitr::kable(format = "latex",
               align = c("l", "c", "c"),
               digits = c(0, 0, 1),
               booktabs = TRUE, escape = FALSE) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "9cm") |>
  kableExtra::column_spec(2, width = "2.5cm") |>
  kableExtra::column_spec(3, width = "2.5cm")

```

#### Remove outliers within each \aqcurve{} curve

*Rationale*: Individual outliers within \agcurve{} curves, usually caused by transitory changes in chamber conditions, exert undue leverage on parameter estimates and cause bias and/or low precision in parameter estimates.

*Procedure*: We fit provisional nonrectangular hyperbola [@marshall_model_1980] to each \aqcurve{} curve using nonlinear regression with the `nlsLM()` function from the *R* package **minpack.lm** version `r packageVersion("minpack.lm")` [@elzhov_minpacklm_2023]. We sequentially removed data points with an absolute external studentized residual $> `r point_outlier_threshold`$ until none remained.

#### Remove \aqcurve{} curves with poor fit

*Rationale*: \aqcurve{} curves with a poor fit to the nonrectangular hyperbola most likely indicate systematic measurement error and/or the leaf was not fully acclimated to the chamber environment. 

*Procedure*: As described above, we fit provisional nonrectangular hyperbola to each \aqcurve{} curve and calculated the model $r^2$. There was a clear break between typical curves and poorly fitting curves where $r^2 < `r aq_r2_threshold`$. We therefore removed \aqcurve{} curves with $r^2 < `r aq_r2_threshold`$.

### Bayesian data analysis in *Stan*

We fit `r n_model` models to test predictions of competing hypotheses about why amphistomy advantage (\aax) might be greater for leaves in sunny, open habitats. This section provides an overview of differences among models (\autoref{tbl-models}). The next sections describe how we fit models in *Stan*, all model parameters and priors, and specific predictions about parameter values for each hypothesis.

```{r, models, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-models
#| tbl-cap: "Summary of differences among competing models of how \\aax{} varies with light intensity, light treatment, and among accessions as a function of native \\ppfd. The models are numbered from simpler to more complex. All models include fixed effects of light intensity and light treatment; some models include interactions between. All models include a phylogenetic random effect of accession on \\aax; some models include varying effects of light intensity and light treatment among accessions. The last column indicates the accession-level \\aax{} variable we used as a response to native \\ppfd."

tribble(
    ~"Model", ~"Fixed effects", ~"Phylogenetic random effects", ~"Response to native \\ppfd",
    "1", "light intensity", "varying intercept among accessions", "$\\mathrm{AA}_{0, \\text{acc}}$",
    "1", "light treatment", "", "",
    "2", "light intensity", "varying intercept among accessions", "$\\mathrm{AA}_{0, \\text{acc}}$",
    "2", "light treatment", "", "",
    "2", "intensity $\\times$ treatment", "", "",
    "3", "light intensity", "varying intercept among accessions", "$\\mathrm{AA}_{2000, \\text{acc}}$",
    "3", "light treatment", "varying effect of high light intensity among accessions", "",
    "4", "light intensity", "varying intercept among accessions", "$\\mathrm{AA}_{\\text{sun, acc}}$",
    "4", "light treatment", "varying effect of sun treatment among accessions", "",
    "5", "light intensity", "varying intercept among accessions", "$\\mathrm{AA}_{2000, \\text{sun, acc}}$",
    "5", "light treatment", "varying effect of high light intensity among accessions", "",
    "5", "intensity $\\times$ treatment", "varying effect of sun treatment among accessions", ""
  ) |>
  knitr::kable(
    format = "latex",
    align = c("c", "l", "l", "l"),
    booktabs = TRUE,
    escape = FALSE,
    longtable = FALSE
  ) |>
    kableExtra::collapse_rows(columns = 1, latex_hline = "major", row_group_label_position = "first") |>
  kableExtra::column_spec(1, width = "0.3in") |>
  kableExtra::column_spec(2, width = "1.3in") |>
  kableExtra::column_spec(3, width = "3.4in") |>
  kableExtra::column_spec(4, width = "1in")

```

#### Fitting models in *Stan* {#sec-fitting}

We fit Bayesian models with MCMC sampling in the probabilistic programming language *Stan* [@stan_development_team_stan_2023]. We used CmdStan version `r fit_aa$version$cmdstan` and **cmdstanr** version `r fit_aa$version$cmdstanr` [@gabry_cmdstanr_2023] to interface with *R* version `r getRversion()` [@r_core_team_r:_2023]. We sampled the posterior distribution from `r dim_fit_aa[2]` chains with `r dim_fit_aa[1]` iterations each after `r dim_fit_aa[1]` warmup iterations per chain. We estimated parameters and confidence intervals as the median and 95% quantile intervals of the posterior, respectively. We chose the number of chains, warmup and sampling iterations, and maximum treedepth so that parameter estimates converged ($\hat{R} < 1.01$ [@gelman_inference_1992]) and the effective sample size (ESS) for each parameter was $> 10^3$.

#### Parameter estimation and priors {#sec-parameters}

There were four levels of parameter estimation in our analysis:

1. Estimate \agcurve{} curve parameters
2. Estimate \aax{} for each light intensity with leaf using \agcurve{} curve parameters
3. Estimate the effects of light intensity, light treatment, and accession on \aax{} (assimilatory and plasticity hypotheses)
4. Estimate the effects of native light habitat on accession-level \aax{} (constitutive hypothesis)

Although the higher-level parameter estimates depend on the lower-level parameter estimates, we fit all models simultaneously to ensure that the uncertainty in lower-level estimates propagated to higher-level estimates. 

```{r, parameters, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-parameters
#| tbl-cap: "Description of parameters estimated in the hierarchical Bayesian model. The `Parameter` column lists the parameter name as it appears in text. The `Description` column provides a brief description of the parameter."

df_parameters = read_csv("../data/parameters1.csv", col_types = "ccccl") |>
    dplyr::filter(include)

df_parameters |>
  dplyr::select(Parameter = latex, Description = description) |>
  knitr::kable(
    format = "latex",
    align = c("l", "l"),
    booktabs = TRUE,
    escape = FALSE,
    longtable = TRUE
  ) |>
  kableExtra::kable_styling(latex_options = c("striped", "no_vertical_lines")) |>
  kableExtra::column_spec(1, width = "1in") |>
  kableExtra::column_spec(2, width = "5in") |>
  kableExtra::pack_rows("\\agcurve{} curve parameters",
                        min(which(df_parameters$par_type == "ags")),
                        max(which(df_parameters$par_type == "ags")),
                        escape = FALSE) |>
  kableExtra::pack_rows("\\aax{} for each light intensity with leaf using \\agcurve{} curve parameters",
                        min(which(df_parameters$par_type == "aa_est")),
                        max(which(df_parameters$par_type == "aa_est")),
                        escape = FALSE) |>
  kableExtra::pack_rows("effects of light intensity, light treatments, and accession on \\aax",
                        min(which(df_parameters$par_type == "aa")),
                        max(which(df_parameters$par_type == "aa")),
                        escape = FALSE) |>
  kableExtra::pack_rows("effects of native light habitat on accession-level \\aax",
                        min(which(df_parameters$par_type == "ppfd_aa")),
                        max(which(df_parameters$par_type == "ppfd_aa")),
                        escape = FALSE)

```

##### \agcurve{} curve parameters

We modeled \logA as a quadratic function of \loggsw for each leaf using the following equation:

$$\log(A_{ij}) = (\beta_0 + b_{0,j}) + (\beta_1 + b_{1,j}) \log{g_{\text{sw},i}} + (\beta_2 + b_{2,j}) \log{g_{\text{sw},i}}^2 + \epsilon_{i}$$

where $\beta_0$, $\beta_1$, and $\beta_2$ are the average intercept, linear, and quadratic coefficients, respectively. We used diffuse normal priors with mean $0$ and standard deviation $10$ on these parameters. We estimated random effects of curve $j$ on the intercept ($b_{0,j}$), linear ($b_{1,j}$), and quadratic ($b_{2,j}$) coefficients. We assumed that the $j \times 3$ array of coefficients was multivariate normal a mean vector of $\vec{0}$ and covariance $\Sigma_\text{curve}$. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ on the log-transformed standard deviations (i.e. the diagonal of $\Sigma_\text{curve}$). We used a weakly informative $\mathrm{LJK}(2)$ prior on the correlation matrix. The off diagonal elements of $\Sigma_\text{curve}$ can be calculated from its diagonal elements and the correlation matrix.

The residuals $\epsilon_{i}$ were modeled as a lag-1 autocorrelated time-series. We further assumed that the residual standard deviation of the $j^{\text{th}}$ curve ($\sigma_{\epsilon,j}$) was inversely proportional to the leaf surface area ($S_j$) within the chamber:

$$\log (\sigma_{\epsilon,j}) = \log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}) + (6 - S_j) \beta_{S,\epsilon}$$
where $\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon}$ is the minimum residual standard deviation when the $\qty{6}{\raiseto{2}\centi\meter}$ chamber is completely filled. The residual standard deviation increases on log-linear scale by $\beta_{S,\epsilon}$. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on $\log (\sigma_{\qty{6}{\raiseto{2}\centi\meter},\epsilon})$ and a weakly informative normal prior with mean $0$ and standard deviation $1$ on $\beta_{S,\epsilon}$.

##### \aax{} for each light intensity with leaf using \agcurve{} curve parameters

Within the $k^{\text{th}}$ leaf, we estimated \aax{} for each light intensity by integrating the difference in \logA{} between the amphi and pseudohypo \agcurve{} curves over the range of \gsw{} values where the curves overlap (from $\min(\log(g_\text{sw}))$ to $\max(\log(g_\text{sw}))$). The estimate of \aax{} for the $k^{\text{th}}$ leaf at light intensity $l$ in accession $m$ is:

$$\widehat{\mathrm{AA}}_{klm} = \int_{\text{min(log(}g_\text{sw}))}^{\text{max(log(}g_\text{sw}))} \text{log}\bigg(\frac{\hat{A}_\text{amphi}(x; \theta_{klm,\text{amphi})}}{\hat{A}_\text{hypo}(x; \theta_{klm,\text{hypo})}}\bigg) dx$$
where:

$$\theta_\text{amphi} \in \{\hat{b}_{0, f(\text{amphi}, k,l,m)}, \hat{b}_{1, f(\text{amphi}, k,l,m)}, \hat{b}_{2, f(\text{amphi}, k,l,m)}\}, \text{and}$$ 

$$\theta_\text{hypo} \in \{\hat{b}_{0, f(\text{hypo}, k,l,m)}, \hat{b}_{1, f(\text{hypo}, k,l,m)}, \hat{b}_{2, f(\text{hypo}, k,l,m)}\}.$$ 
The function $f : \Theta_1 \rightarrow \Theta_2$ maps the set $\Theta_1$ indexed by leaf type (amphi or pseudohypo), leaf replicate, light intensity, and accession to set $\Theta_2$ indexed by individual \agcurve{} curve. This mapping is necessary because the random effects structure differs between models of \loggsw{} on \logA{} and that of models predicting \aax{} described in the next section.

##### Effects of light intensity, light treatment, and accession on \aax

We tested for effects of light intensity, light treatment, accession, and their interactions on \aax. All models included effects of light intensity and light treatment, as well as random effects of accession and replicate within accession. More complex models included interactions between light intensity and light treatment, as well as random effects of accession on the effects of light intensity and light treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ for fixed effects of light intensity and treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ for the the random effect standard deviation of replicate within accession. We accounted for the phylogenetic structure among the random effects of accession using an Ornstein-Uhlenbeck (OU) process [@hansen_stabilizing_1997]. The expected covariance between accessions $i$ and $j$ ($\text{Cov}(i, j)$ ) is:

$$\text{Cov}(i, j) = \frac{\sigma^2}{2 \alpha} \exp(-\alpha D_{ij})$$
where $\sigma^2$ is the variance of the random effect, $\alpha$ is the rate of decay of the covariance with phylogenetic distance, $D_{ij}$, the phylogenetic distance between accessions $i$ and $j$. We estimated $\sigma^2 / (2 \alpha)$ and $\alpha$ as a separate parameters and reparameterized them as $\sigma^2$ and $\alpha$. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. 

We modeled the residual standard deviation of \aax, (i.e. phylogenetically unstructured variation unaccounted for by explanatory variables) on a log-link scale with effects of light intensity and light treatment. We used a weakly informative normal prior with mean $-3$ and standard deviation $5$ on the residual standard deviation intercept and a weakly informative normal prior with mean $0$ and standard deviation $1$ on the effects of light intensity and light treatment on the residual standard deviation.

##### Effects of native light habitat on accession-level \aax

We tested a linear effect of native light habitat on accession-level \aax. In Models 1 and 2, we used the random intercept of \aax{} as a response variable; in model 3 we used the random intercept plus the random effect of accession at high light intensity; in model 4 we used the random intercept plus the random effect of accession in the sun treatment; in model 5 we used the random intercept plus the random effects of accession at high light intensity and sun treatment. We used a weakly informative normal prior with mean $0$ and standard deviation $1$ for the slope and intercept. We accounted for the phylogenetic structure among the model residuals using an (OU) process. We used a weakly informative normal prior with mean $0$ and standard deviation $10$ on OU parameters. 

#### Predictions {#sec-predictions}

The assimilatory, plastic, and constitutive hypotheses make different predictions about the relationship between \aax{} and light intensity, light treatment, and native \ppfd{} among accessions. Since these hypotheses are not mutually exclusive, we describe how we assessed support for one, two, or all three hypotheses simultaneously in \autoref{tbl-predictions}. In general, the assimilatory hypothesis was supported if \aax{} was greater at high light intensity than low light intensity. The plastic hypothesis was supported if \aax{} was greater in sun leaves than shade leaves. The constitutive hypothesis was supported if accession-level \aax{} increased with native \ppfd. In interactive models, we only consider positively reinforcing interactions between high light intensity, sun leaves, and native \ppfd{} because these are the only interactions which could explain why amphistomatous leaves are advantageous in high light habitats.

We evaluated predictions using a combination of parameter estimation and model selection. In all cases, we estimated parameters and confidence intervals as described in @sec-fitting. If the 95% confidence intervals for a parameter did not overlap zero, we considered the parameter to be significantly different from zero. We used the leave-one-out cross-validation information criterion (LOOIC) to compare the fit of models (\autoref{tbl-models}) using the *R* package **loo** version `r packageVersion("loo")` [@vehtari_practical_2017] to calculate LOOIC values. Note that LOOIC was calculated only from pointwise likelihood values of the submodel estimating effects of light intensity, light treatments, and accession on \aax{} (see @sec-parameters). We considered models with two standard errors of the mean lower LOOIC value to be a better fit to the data; we considered models with LOOIC values within two standard errors of the mean to be have similar support.

```{r, predictions, eval=TRUE, echo=FALSE,message=FALSE,warning=FALSE}
#| label: tbl-predictions
#| tbl-cap: "Predictions of competing hypotheses about the relationship between \\aax{} and light intensity, light treatment, and native \\ppfd{} among accessions. The middle column lists specific directional predictions about parameter values and model fit according to leave-one-out cross-validation information criterion (LOOIC), where $\\text{LOOIC}_i$ is the LOOIC value for model $i$. The rightmost column describes the predictions in words and explains how accession-level \\aax{} is calculated in the relevant model."

tribble(
  ~"\\textbf{Hypothesis}", ~"\\textbf{Prediction(s)}", ~"\\textbf{Description}",
  "Assimilatory", "$\\beta_{\\mathrm{AA},2000} > 0$", "Average \\aax{} at high light intensity is greater than that at low light intensity",
  "Plastic", "$\\beta_{\\mathrm{AA},\\text{sun}} > 0$", "Average \\aax{} in sun leaves is greater than that in shade leaves",
  "Constitutive", "$\\beta_{\\mathrm{PPFD,AA}} > 0$", "Accession-level \\aax{} ($\\mathrm{AA}_\\text{acc}$) increases with native \\ppfd",
  "Constitutive", "", "$\\mathrm{AA}_\\text{acc} = \\beta_{\\mathrm{AA}, 0} + \\vec{\\beta}_{\\mathrm{AA}, \\text{acc}}$",
  "Assimilatory $\\times$ Plastic", "$\\beta_{\\mathrm{AA},2000,\\text{sun}} > 0$", "Average \\aax{} is highest at high light intensity in sun leaves",
  "Assimilatory $\\times$ Plastic", "$\\text{LOOIC}_\\text{1} > \\text{LOOIC}_\\text{2}$", "",
  "Assimilatory $\\times$ Constitutive", "$\\beta_{\\mathrm{AA},2000} > 0$", "Average \\aax{} at high light intensity is greater than that at low light intensity",
  "Assimilatory $\\times$ Constitutive", "$\\beta_{\\mathrm{PPFD,AA}} > 0$", "Accession-level \\aax{} at high light intensity ($\\mathrm{AA}_{\\text{acc},2000}$) increases with native \\ppfd",
  "Assimilatory $\\times$ Constitutive", "$\\text{LOOIC}_\\text{1} > \\text{LOOIC}_\\text{3}$", "$\\mathrm{AA}_{\\text{acc},2000} = \\beta_{\\mathrm{AA}, 0} + \\vec{\\beta}_{\\mathrm{AA}, \\text{acc}} + \\vec{\\beta}_{\\mathrm{AA}, 2000, \\text{acc}}$",
  "Plastic $\\times$ Constitutive", "$\\beta_{\\mathrm{AA},\\text{sun}} > 0$", "Average \\aax{} in sun leaves is greater than that in shade leaves",
  "Plastic $\\times$ Constitutive", "$\\beta_{\\mathrm{PPFD,AA}} > 0$", "Accession-level \\aax{} in sun leaves ($\\mathrm{AA}_{\\text{acc},\\text{sun}}$) increases with native \\ppfd",
  "Plastic $\\times$ Constitutive", "$\\text{LOOIC}_\\text{1} > \\text{LOOIC}_\\text{4}$", "$\\mathrm{AA}_{\\text{acc},\\text{sun}} = \\beta_{\\mathrm{AA}, 0} + \\vec{\\beta}_{\\mathrm{AA}, \\text{acc}} + \\vec{\\beta}_{\\mathrm{AA}, \\text{sun}, \\text{acc}}$",
  "Assimilatory $\\times$ Plastic $\\times$ Constitutive", "$\\beta_{\\mathrm{AA},2000,\\text{sun}} > 0$", "Average \\aax{} is highest at high light intensity in sun leaves",
  "Assimilatory $\\times$ Plastic $\\times$ Constitutive", "$\\beta_{\\mathrm{PPFD,AA}} > 0$", "Accession-level \\aax{} at high light intensity in sun leaves ($\\mathrm{AA}_{\\text{acc},2000,\\text{sun}}$) increases with native \\ppfd",
  "Assimilatory $\\times$ Plastic $\\times$ Constitutive", "$\\text{LOOIC}_\\text{3} > \\text{LOOIC}_\\text{5}$", "$\\mathrm{AA}_{\\text{acc},2000,\\text{sun}} = \\beta_{\\mathrm{AA}, 0} + \\vec{\\beta}_{\\mathrm{AA}, \\text{acc}} + \\vec{\\beta}_{\\mathrm{AA}, 2000, \\text{acc}} + \\vec{\\beta}_{\\mathrm{AA}, \\text{sun}, \\text{acc}}$"

) |>
  knitr::kable(
    format = "latex",
    align = c("l", "l", "l"),
    booktabs = TRUE,
    escape = FALSE,
    longtable = TRUE
  ) |>
  kableExtra::add_indent(positions = seq_len(15), level_of_indent = -1, target_cols = 3) |>
  kableExtra::collapse_rows(1, latex_hline = "major", valign = "top",
                            row_group_label_position = "first") |>
  kableExtra::column_spec(1, width = "1in") |>
  kableExtra::column_spec(2, width = "1.5in") |>
  kableExtra::column_spec(3, width = "3in")

```

## Acknowledgements

Justin Alter, Max Gatlin, Joana Kim, Jenna Matsuyama, Brandon Najarian, Kai Yasuda. Sarah Friedrich helped with figures.


## References